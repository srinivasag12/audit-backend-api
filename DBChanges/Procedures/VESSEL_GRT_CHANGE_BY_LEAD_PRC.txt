CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.Vessel_GRT_Change_by_lead_Prc (pVslImoNo     VARCHAR2,
                                                   pOldVal       NUMBER,
                                                   pNewval       NUMBER,
                                                   pUpdatedBy    VARCHAR2,
                                                   pLeadAud      VARCHAR2)
AS
vaudit_status_id number;
vTO varchar2(100);--:=audit_details_pkg.v_admin;
vSub    VARCHAR2 (1000);
vBody   VARCHAR2 (1000);
vCC     VARCHAR2 (1000);
BEGIN
SELECT USER_ID INTO vTo from ma_user_roles where role_id=1002;
select audit_status_id INTO vaudit_status_id from audit_details where AUDIT_SEQ_NO=602243;
   SELECT muliple_replace_fun (subject,
                               NEW t_text ('RMI Admin'),
                               NEW t_text (vTO)),
          muliple_replace_fun (
             body,
             NEW t_text ('Old Value__',
                         'New Value___(Latest)',
                         'Lead Auditor ___',
                         'Vessel IMO No.___'),
             t_text ('Old Value ' ||pOldVal ,
                     'New Value ' || pNewval,
                     'Lead Auditor ' || pNewval,
                     'Vessel IMO No ' || pVslImoNo || '..!!!'))
     INTO vSub, vBody
     FROM (SELECT subject, body
             FROM audit_email_dtls
            WHERE email_seq = 36);
            dbms_output.put_line(vBody);
            dbms_output.put_line(vSub);


if vaudit_status_id =1002 then
   SELECT listagg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO vCC
     FROM ma_user_roles
    WHERE role_id in (SELECT role_id
                       FROM ma_roles
                      WHERE role_desc in('Manager','Auditor'));
                      end if;
                  
dbms_output.put_line(pVslImoNo);
dbms_output.put_line(audit_details_pkg.v_From);
dbms_output.put_line(audit_details_pkg.v_admin);
--dbms_output.put_line(vCC);
dbms_output.put_line(vSub);
dbms_output.put_line(vBody); 
  audit_send_mail_prc (
      'Updating of GRT value for the Vessel IMO No ' || pVslImoNo,
      NULL,
      audit_details_pkg.v_From,
      audit_details_pkg.v_admin,
      vCC,
      vSub,
      vBody);
END;
/
