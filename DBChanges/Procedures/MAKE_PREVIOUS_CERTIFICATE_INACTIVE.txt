CREATE OR REPLACE PROCEDURE LOCAL_AUDIT_CHANGES.MAKE_PREVIOUS_CERTIFICATE_INACTIVE (
   p_audit_seq_no        NUMBER,
   p_certificate_no      VARCHAR2,
   p_audit_type_id       NUMBER,
   p_company_id          NUMBER,
   p_vessel_imo_no NUMBER,
   p_seq_no            NUMBER,
   p_certificate_issue_id NUMBER,
   p_status              VARCHAR2)
   
  AS
  v_status1  VARCHAR(50);
   v_status2  VARCHAR(50);
   v_audit_seq_no NUMBER;
   v_count_audit_seq_no NUMBER;
   v_seq_no NUMBER;
   v_count NUMBER;
  
  PRAGMA AUTONOMOUS_TRANSACTION; 
    
   BEGIN 
   dbms_output.put_line ('procedure');
     SELECT REGEXP_SUBSTR(p_status,'[^-]+',1,1),REGEXP_SUBSTR(p_status,'[^-]+',1,2)
      INTO v_status1, v_status2
      FROM DUAL; 
      
      
      IF((v_status1='intermediate' AND v_status2 ='endorsement') OR (v_status1='additional' AND v_status2 ='endorsement')) AND p_certificate_issue_id <> 1008 AND  p_certificate_issue_id <> 1003
      THEN 
      
      UPDATE CERTIFICATE_DETAIL 
      SET ACTIVE_STATUS =0
      WHERE COMPANY_ID = p_company_id
      AND AUDIT_TYPE_ID = p_audit_type_id
      AND AUDIT_SEQ_NO NOT IN (p_audit_seq_no)
      AND VESSEL_IMO_NO = p_vessel_imo_no;
      END IF; 
      
      /*  IF((v_status1='intermediate' AND v_status2 ='extension') OR (v_status1='additional' AND v_status2 ='extension')) AND p_certificate_issue_id <> 1008 AND  p_certificate_issue_id = 1003 
      THEN 
      
      UPDATE CERTIFICATE_DETAIL 
      SET ACTIVE_STATUS =0
      WHERE COMPANY_ID = p_company_id
      AND AUDIT_TYPE_ID = p_audit_type_id
      AND AUDIT_SEQ_NO NOT IN (p_audit_seq_no)
      AND VESSEL_IMO_NO = p_vessel_imo_no;
      END IF; */
      
       IF((v_status1 ='interim' AND v_status2='interim') OR (v_status1='fullterm' AND v_status2='fullterm')) AND  p_certificate_issue_id <> 1008 AND  p_certificate_issue_id <> 1003
       
         THEN 
          dbms_output.put_line ('inside fullterm certificate-- prc make_previous_certificate_inactive');
         UPDATE CERTIFICATE_DETAIL 
         SET ACTIVE_STATUS =0 
         WHERE VESSEL_IMO_NO = p_vessel_imo_no
         AND AUDIT_TYPE_ID = p_audit_type_id
         AND AUDIT_SEQ_NO < p_audit_seq_no
         AND COMPANY_ID = p_company_id;
        END IF;
        
        IF(v_status1 ='interim' AND v_status2='reissue') OR (v_status1='fullterm' AND v_status2='reissue')
         THEN 
          
         UPDATE CERTIFICATE_DETAIL 
         SET ACTIVE_STATUS =0 
         WHERE VESSEL_IMO_NO = p_vessel_imo_no
         AND AUDIT_TYPE_ID = p_audit_type_id
         AND AUDIT_SEQ_NO IN (p_audit_seq_no)
         AND COMPANY_ID = p_company_id
         AND SEQ_NO <> p_seq_no;
        END IF;
        
        IF ( v_status1='fullterm' AND v_status2='extension')  
        
        THEN
             
                UPDATE CERTIFICATE_DETAIL 
               SET ACTIVE_STATUS =0 
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND AUDIT_SEQ_NO = p_audit_seq_no
              AND COMPANY_ID = p_company_id
              AND SEQ_NO <> p_seq_no; 
              
              /*if both needed to be active for the initial --> intermediate --> then extension comment the below query and even change the line no 292 in procedure REISSUE_CERTIFICATE_INTERORADD to value 1*/
               UPDATE CERTIFICATE_DETAIL 
               SET ACTIVE_STATUS =0 
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND CERTIFICATE_NO = p_certificate_no
              AND COMPANY_ID = p_company_id
              AND ACTIVE_STATUS=1
              AND AUDIT_SEQ_NO > p_audit_seq_no
              AND CERTIFICATE_ISSUE_ID<>p_certificate_issue_id; 
        
        END IF; 
        
        
          
        IF ( v_status1='intermediate' AND v_status2='extension') OR (v_status1='additional' AND v_status2='extension')
        
        THEN
             
                UPDATE CERTIFICATE_DETAIL 
               SET ACTIVE_STATUS =0 
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND AUDIT_SEQ_NO < p_audit_seq_no
              AND COMPANY_ID = p_company_id
              AND CERTIFICATE_NO = p_certificate_no
              /*AND SEQ_NO NOT IN (p_seq_no)*/
              AND ACTIVE_STATUS =1 ; 
               
               UPDATE CERTIFICATE_DETAIL 
               SET ACTIVE_STATUS =0 
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND AUDIT_SEQ_NO IN p_audit_seq_no
              AND COMPANY_ID = p_company_id
               AND CERTIFICATE_NO = p_certificate_no
               AND SEQ_NO <> p_seq_no
              AND ACTIVE_STATUS =1 ;
              
            /*  UPDATE  CERTIFICATE_DETAIL 
              SET ACTIVE_STATUS =0
              WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND AUDIT_SEQ_NO <p_audit_seq_no
              AND AUDIT_TYPE_ID IN (1001,1002,1004)
              AND ACTIVE_STATUS = 1; */
        
        END IF; 
        
        
        IF(v_status1 ='endorsement' AND v_status2='reissue0')
        THEN 
        
         UPDATE CERTIFICATE_DETAIL
         SET ACTIVE_STATUS=1
         WHERE VESSEL_IMO_NO = p_vessel_imo_no
         AND AUDIT_TYPE_ID = p_audit_type_id
         AND AUDIT_SEQ_NO= p_audit_seq_no
         AND SEQ_NO = p_seq_no - 1;
        
        
            ELSE IF (v_status1 ='endorsement' AND v_status2='reissue1')
            
             THEN 
             
               UPDATE CERTIFICATE_DETAIL
               SET ACTIVE_STATUS=0
                WHERE VESSEL_IMO_NO = p_vessel_imo_no
                 AND AUDIT_TYPE_ID = p_audit_type_id
                 AND AUDIT_SEQ_NO= p_audit_seq_no
                 AND SEQ_NO = p_seq_no - 1;
        
            END IF;
        /*SELECT COUNT(*)
        INTO v_count_audit_seq_no
        FROM CERTIFICATE_DETAIL 
        WHERE VESSEL_IMO_NO = p_vessel_imo_no
        AND AUDIT_TYPE_ID = p_audit_type_id
        AND COMPANY_ID = p_company_id
        AND CERTIFICATE_NO = p_certificate_no;
        
           IF v_count_audit_seq_no>1
           
           THEN 
           
             FOR I IN (SELECT AUDIT_SEQ_NO 
             FROM  CERTIFICATE_DETAIL
             WHERE VESSEL_IMO_NO = p_vessel_imo_no
             AND AUDIT_TYPE_ID = p_audit_type_id
             AND COMPANY_ID = p_company_id
             AND CERTIFICATE_NO = p_certificate_no)
             
             LOOP
                    v_audit_seq_no :=I.AUDIT_SEQ_NO ;
                    
                    UPDATE CERTIFICATE_DETAIL
                    SET ACTIVE_STATUS=0
                    WHERE VESSEL_IMO_NO = p_vessel_imo_no
                    AND AUDIT_TYPE_ID = p_audit_type_id
                    AND COMPANY_ID = p_company_id
                     AND CERTIFICATE_NO = p_certificate_no
                     AND SEQ_NO <> (SELECT MAX(SEQ_NO)
                     FROM CERTIFICATE_DETAIL
                     WHERE VESSEL_IMO_NO = p_vessel_imo_no
                     AND AUDIT_TYPE_ID = p_audit_type_id
                    AND COMPANY_ID = p_company_id
                     AND CERTIFICATE_NO = p_certificate_no);
                    
                
                
             END LOOP;
           
           END IF;*/
        
        END IF;
      
      
      
      
      /*IF(( v_status1 = 'endorsement' AND v_status2 = 'notReissue') OR ( v_status1 = 'fullterm' AND v_status2 = 'fullterm'))
      THEN 
      UPDATE CERTIFICATE_DETAIL set ACTIVE_STATUS =0
      WHERE COMPANY_ID = p_company_id
      AND AUDIT_TYPE_ID = p_audit_type_id
      AND AUDIT_SEQ_NO NOT IN (p_audit_seq_no)
      AND VESSEL_IMO_NO IN p_vessel_imo_no;
      
          ELSE IF (  v_status1 = 'interimOrFulltermOrEndorsement' AND v_status2 = 'Reissue')
           THEN 
            UPDATE CERTIFICATE_DETAIL
            SET ACTIVE_STATUS =0
            WHERE COMPANY_ID = p_company_id
            AND AUDIT_TYPE_ID =  p_audit_type_id
            AND AUDIT_SEQ_NO IN p_audit_seq_no
            AND SEQ_NO NOT IN p_seq_no;
      
          END IF;
         
      END IF;
      
           IF( v_status1 ='fulltermFollowedByEndorsement' AND v_status2 = 'Reissue')
          THEN 
          
          FOR I IN  (SELECT AUDIT_SEQ_NO 
          FROM CERTIFICATE_DETAIL
          WHERE VESSEL_IMO_NO = p_vessel_imo_no
          AND AUDIT_TYPE_ID = p_audit_type_id
          AND CERTIFICATE_NO =p_certificate_no)
          
            LOOP 
            
              v_audit_seq_no := I.AUDIT_SEQ_NO;
              
              UPDATE CERTIFICATE_DETAIL 
              SET  ACTIVE_STATUS =0, PUBLISH_STATUS=0
              WHERE VESSEL_IMO_NO = p_vessel_imo_no
              AND AUDIT_TYPE_ID = p_audit_type_id
              AND CERTIFICATE_NO =p_certificate_no
              AND AUDIT_SEQ_NO <> p_audit_seq_no
              AND AUDIT_SEQ_NO = v_audit_seq_no;
              
              
              
            END LOOP;
          
          END IF;
      
      COMMIT;*/
      COMMIT;
   END;
/
