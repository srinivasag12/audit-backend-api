CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.Certificate_Expire_Prc
AS
   CURSOR c
   IS
      (SELECT ad.audit_seq_no,
              ad.company_id,
              ad.certificate_no,
              mci.certificate_issue_desc,
              at.audit_type_desc,
              ast.audit_subtype_desc,
              TRUNC (cert_expiry_date - SYSDATE)
         FROM audit_details ad,
              ma_certificate_issued mci,
              ma_audit_type at,
              ma_audit_subtype ast
        WHERE     ad.certificate_issue_id = mci.certificate_issue_id
              AND ad.audit_type_id = mci.audit_type_id
              AND ad.company_id = mci.company_id
              AND ad.audit_type_id = at.audit_type_id
              AND ad.company_id = at.company_id
              AND ad.audit_sub_type_id = ast.audit_sub_type_id
              AND ad.audit_type_id = ast.audit_type_id
              AND ad.company_id = ast.company_id
              AND TRUNC (cert_expiry_date - SYSDATE) IN
                     (SELECT expiry_days
                        FROM audit_validtity_days_dtls
                       WHERE email_seq = 15
                             AND company_id =
                                    (SELECT company_id
                                       FROM ma_company
                                      WHERE company_name LIKE
                                               'MARSHALL ISLANDS')));

   v_from                     VARCHAR2 (30) := audit_details_pkg.v_from;
   v_to                       VARCHAR2 (1000);
   v_audit_seq_no             NUMBER;
   v_subject                  VARCHAR2 (200);
   v_body                     VARCHAR2 (3000);
   v_certificate_no           VARCHAR2 (100);
   v_company_id               NUMBER;
   v_count                    NUMBER;       --number of days need to calculate
   v_cc                       VARCHAR2 (100) ;--:= audit_details_pkg.v_admin;
   v_expir_days               NUMBER;
   v_certificate_issue_desc   VARCHAR2 (100);
   v_audit_type_desc          VARCHAR2 (100);
   v_audit_subtype_desc       VARCHAR2 (100);
   v_admin varchar2(200);
BEGIN

   --12-01-2018
   --still need to include handling of email details and count has to decrement day by day
   OPEN c;

   LOOP
      FETCH c
      INTO v_audit_seq_no,
           v_company_id,
           v_certificate_no,
           v_certificate_issue_desc,
           v_audit_type_desc,
           v_audit_subtype_desc,
           v_expir_days;

      EXIT WHEN c%NOTFOUND;

      --to >> Manager, &    Vessel Operator
      --cc > IRI Admin
      --picking of manager details
      SELECT listagg (user_id) WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_to
        FROM ma_user_roles
       WHERE role_id IN
                (SELECT role_id
                   FROM ma_roles
                  WHERE role_desc LIKE 'Manager'
                        AND company_id = v_company_id)
             AND company_id = v_company_id;

      DBMS_OUTPUT.PUT_LINE('v_audit_seq_no ' || v_audit_seq_no);


      DBMS_OUTPUT.PUT_LINE (
            v_audit_seq_no
         || ' >> '
         || v_certificate_no
         || ' >> '
         || v_company_id
         || ' >> '
         || v_certificate_issue_desc
         || ' >> '
         || v_audit_type_desc
         || ' >> '
         || v_audit_subtype_desc
         || ' >> '
         || v_expir_days);

      SELECT muliple_replace_fun (
                subject,
                NEW t_text ('Certificate No.__', 'expiring __'),
                NEW t_text ('Certificate No. ' || v_certificate_no,
                            'expiring ' || v_expir_days)),
             muliple_replace_fun (
                body,
                NEW t_text ('Audit Type__',
                            'Audit Subtype__',
                            'Certificate Type__',
                            'Certificate No.___',
                            'expiring in ____'),
                NEW t_text ('Audit Type ' || v_audit_type_desc,
                            'Audit Subtype ' || v_audit_subtype_desc,
                            'Certificate Type ' || v_certificate_issue_desc,
                            'Certificate No. ' || v_certificate_no,
                            'expiring in ' || v_expir_days))
        INTO v_subject, v_body
        FROM (SELECT subject, body
                FROM audit_email_dtls
               WHERE email_seq = 15);
               
               SELECT listAgg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 and company_id=v_company_id;
    v_cc:=v_admin;
dbms_output.put_line(v_subject);
dbms_output.put_line(v_body);
dbms_output.put_line(v_company_id);
dbms_output.put_line(v_from);
dbms_output.put_line(v_to);
dbms_output.put_line(v_cc);
      -- mail send proce calling
      audit_send_mail_prc ('Certificate expiry for ' || v_audit_seq_no,
                           v_company_id,
                           v_from,
                           v_to,
                           v_cc,
                           v_subject,
                           v_body);
   END LOOP;

   CLOSE c;
EXCEPTION
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line (
         SQLERRM || ' >> ' || DBMS_UTILITY.format_error_backtrace);
END;
/
