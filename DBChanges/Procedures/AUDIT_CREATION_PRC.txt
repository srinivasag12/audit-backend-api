CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.audit_creation_prc (
   p_audit_no      NUMBER,
   p_company_id    NUMBER)
AS
v_admin varchar2(200 byte);
   v_from                     VARCHAR2 (30) := audit_details_pkg.v_from;
   v_to                       VARCHAR2 (100);
   v_cc                       VARCHAR2 (100); --:= audit_details_pkg.v_admin;
   v_subject                  VARCHAR2 (200);
   v_body                     VARCHAR2 (1000);
   v_sub                      VARCHAR2 (200);
   v_bdy                      VARCHAR2 (1000);
   v_audit_type_desc          VARCHAR2 (100);
   v_user_name                VARCHAR2 (100);
   v_vessel_imo_no            NUMBER;
   v_certificate_issue_desc   VARCHAR2 (100);
   v_audit_subtype_desc       VARCHAR2 (100);
BEGIN
SELECT listAgg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 and company_id=p_company_id;
v_cc:=v_admin;
   SELECT subject, body
     INTO v_sub, v_bdy
     FROM audit_email_dtls
    WHERE email_seq = 4;


   SELECT muliple_replace_fun (
             v_sub,
             NEW t_text ('Audit Type:__',
                         'Vessel IMO No.:__',
                         'Certificate#:__'),
             NEW t_text ('Audit Type: ' || audit_type_desc,
                         'Vessel IMO No.:' || vessel_imo_no,
                         'Certificate#:' || certificate_issue_desc)),
          muliple_replace_fun (
             v_bdy,
             NEW t_text ('Audit type__',
                         'Vessel IMO No__',
                         'Audit Subtype__',
                         'succeessfully by __(Whom)__'),
             NEW t_text ('Audit type ' || audit_type_desc,
                         'Vessel IMO No ' || vessel_imo_no,
                         'Audit Subtype ' || audit_subtype_desc,
                         'succeessfully by ' || user_name))
     INTO v_subject, v_body
     FROM (SELECT ad.vessel_imo_no,
                  mci.certificate_issue_desc,
                  at.audit_type_desc,
                  ast.audit_subtype_desc,
                  mu.first_name || ' ' || mu.last_name user_name
             FROM audit_details ad,
                  ma_certificate_issued mci,
                  ma_audit_type at,
                  ma_audit_subtype ast,
                  ma_users mu
            WHERE     ad.certificate_issue_id = mci.certificate_issue_id
                  AND ad.audit_type_id = mci.audit_type_id
                  AND ad.company_id = mci.company_id
                  AND ad.audit_type_id = at.audit_type_id
                  AND ad.company_id = at.company_id
                  AND ad.audit_type_id = ast.audit_type_id
                  AND ad.audit_sub_type_id = ast.audit_sub_type_id
                  AND ad.company_id = ast.company_id
                  AND ad.user_ins = mu.user_id
                  AND ad.company_id = mu.company_id
                  AND ad.audit_seq_no = p_audit_no
                  AND ad.company_id = p_company_id) test;


      SELECT listagg (mu.user_id, ',') WITHIN GROUP (ORDER BY sequence_number)
        INTO v_to
        FROM audit_auditor_details aad, ma_users mu
       WHERE aad.user_id = mu.sequence_number AND aad.company_id = mu.company_id
             AND aad.audit_role_id IN
                    (SELECT audit_role_id
                       FROM ma_audit_roles
                      WHERE REGEXP_LIKE (audit_role_desc,
                                         'AUDITOR|OBSERVER|REVIEWER')
                            AND company_id = p_company_id)   --(1001, 1002, 1003)
             AND aad.audit_seq_no = p_audit_no                           --600827
             AND aad.company_id = p_company_id;

   DBMS_OUTPUT.put_line (v_subject || ' >> ' || v_body);

   audit_send_mail_prc ('New Audit ' || p_audit_no,
                        p_company_id,
                        v_from,
                        v_to,
                        v_cc,
                        v_subject,
                        v_body);
EXCEPTION
   WHEN OTHERS
   THEN
      NULL;
      DBMS_OUTPUT.put_line (SQLERRM);
END;
/
