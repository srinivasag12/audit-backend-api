CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.IMO_Vessel_Chk_PRC (
   p_vsl_imo_no    VARCHAR2,
   p_company_id    NUMBER)
AS
   V_FROM      VARCHAR2 (100) := AUDIT_DETAILS_PKG.v_from;
   V_TO        VARCHAR2 (10000) := AUDIT_DETAILS_PKG.V_ADMIN;
   V_SUBJECT   VARCHAR2 (1000);
   V_BODY      VARCHAR2 (30000);
   v_count     NUMBER;
BEGIN
   --Query to pick email body and subject

   --checking of vessel IMO exist on IRI system, If not exist notifcation will send

   SELECT COUNT (*)
     INTO v_count
     FROM ma_vessel
    WHERE VESSEL_IMO_NO = p_vsl_imo_no                             --'7658888'
                                      AND company_id = p_company_id;      --2;

   --dbms_output.put_line(' 1st >> '|| v_count);
   IF v_count = 0                                -- ensures IMO no not present
   THEN
      SELECT A.SUBJECT, A.BODY
        INTO V_SUBJECT, V_BODY
        FROM audit_email_dtls A
       WHERE EMAIL_SEQ = 1;

      DBMS_OUTPUT.put_line (V_SUBJECT || ',' || V_BODY);
      --- SUB >>  --Vessel "IMO No:__" doesn't exist
      V_SUBJECT :=
         REPLACE (V_SUBJECT, 'IMO No:__', 'IMO No: ' || p_vsl_imo_no);

      DBMS_OUTPUT.put_line (V_SUBJECT || ',' || V_BODY);

      AUDIT_SEND_MAIL_PRC (p_vsl_imo_no,
                           p_company_id,
                           V_FROM,
                           V_TO,
                           NULL,
                           V_SUBJECT,
                           V_BODY);
   /*
   --Commented because of not needed in new requirement
      ELSIF v_count >= 1 -- IMO no present, Checking of vessel details for the vessel IMO number
      THEN
         --If IMO NO present, but no Vessel Details

         v_count := NULL;
   --                  dbms_output.put_line(' 2nd  >> '|| v_count);
           --picking of vessel details for the IMO no
         SELECT COUNT (*)
           INTO v_count
           FROM MA_VESSEL_COMPANY
          WHERE (company_id, COMPANY_IMO_NO) =
                   (SELECT company_id, COMPANY_IMO_NO
                      FROM ma_vessel
                     WHERE VESSEL_IMO_NO = p_vsl_imo_no               --'7658888'
                           AND company_id = p_company_id);

   --            dbms_output.put_line(' 3nd  >> '|| v_count);
                 IF v_count = 0 -- Ensures Vessel details not present, notification will send
                 THEN
                   select A.SUBJECT , A.BODY  INTO V_SUBJECT, V_BODY
                   from iri_audit_email_dtls A where EMAIL_SEQ = 15;

                    IRI_AUDIT_SEND_MAIL_PRC (p_vsl_imo_no,
                                             p_company_id,
                                             V_FROM,
                                             V_TO,
                                             V_SUBJECT,
                                             V_BODY);
                 ELSE -- ensures vessel details present for the IMO number, no operation will be performed
                    NULL;
                 END IF;
   */
   ELSE
      NULL;
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      /*
      Incase of exception, error details will be recorded in email out log table,
      For me : eNeed to add extra column in log table
      */
      NULL;
END;
/
