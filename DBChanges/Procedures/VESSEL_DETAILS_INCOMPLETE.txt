CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.VESSEL_DETAILS_INCOMPLETE (
   p_vesselImo        NUMBER,
   p_vesselId         NUMBER,
   p_lead_Id          VARCHAR2,
   p_company_id       NUMBER,
   p_audit_type_id    NUMBER,
   p_due_date         DATE)
AS
   v_to_mail              VARCHAR2 (200) := audit_details_pkg.v_from;
   v_cc_mail              VARCHAR2 (400);
   v_from                 VARCHAR2 (30) := audit_details_pkg.v_from;
   v_body                 VARCHAR2 (200);
   v_sub                  VARCHAR2 (1000);
   v_bdy                  VARCHAR2 (1000);
   v_sub1                 VARCHAR2 (1000);
   v_bdy1                 VARCHAR2 (1000);
   v_vessel_imo_no        NUMBER := p_vesselImo;
   v_vessel_id            NUMBER := p_vesselId;
   vessel_name1           VARCHAR2 (200);
   official_no1           NUMBER;
   doc_type1              VARCHAR (100);
   doc_type_number1       VARCHAR2 (100);
   v_err_msg              VARCHAR2 (1000);
   v_company_imo_number   VARCHAR2 (150);
   v_due_date             VARCHAR2(50);
   v_role_name            VARCHAR2 (100);
   v_role_desc            VARCHAR2 (100);
   audit_desc_msg         VARCHAR2 (50);
BEGIN
   SELECT NAME,
          OFFICIAL_NUMBER,
          doc_type,
          doc_type_number,
          COMPANY_IMO_NUMBER
     INTO vessel_name1,
          official_no1,
          doc_type1,
          doc_type_number1,
          v_company_imo_number
     FROM vssl_vessel_info_v
    WHERE IMO_NUMBER = p_vesselImo;

   IF p_audit_type_id IN (1004, 1005)
   THEN
      audit_desc_msg := 'Review';
   ELSIF p_audit_type_id IN (1003)
   THEN
      audit_desc_msg := 'Inspection';
   ELSIF p_audit_type_id IN (1001, 1002)
   THEN
      audit_desc_msg := 'Audit';
   ELSE
      audit_desc_msg := NULL;
   END IF;

   --   SELECT VESSDOCDEPTID
   --     INTO v_to_mail
   --     FROM MA_COMPANY
   --    WHERE COMPANY_ID = p_comapnyId;

   SELECT LISTAGG (USER_ID, ',') WITHIN GROUP (ORDER BY USER_ID)
     INTO v_cc_mail
     FROM MA_USER_ROLES
    WHERE ROLE_ID = 1002 AND COMPANY_ID = p_company_id;

   SELECT v_cc_mail || ',' || p_lead_Id INTO v_cc_mail FROM DUAL;

   SELECT subject, body
     INTO v_sub, v_bdy
     FROM audit_email_dtls
    WHERE email_seq = 29;

   SELECT FIRST_NAME || ' ' || LAST_NAME
     INTO v_role_name
     FROM MA_USERS
    WHERE USER_ID = p_lead_Id AND COMPANY_ID = p_company_id;
    

  SELECT TO_CHAR (TO_DATE (p_due_date, 'DD-MM-RRRR'), 'DD-MON-YYYY')
     INTO v_due_date
     FROM DUAL;

   SELECT CASE
             WHEN role_desc = 'Auditor'
             THEN
                (CASE
                    WHEN p_audit_type_id IN (1001, 1002, 1004) THEN 'Auditor'
                    ELSE ' Inspector'
                 END)
             ELSE
                role_desc
          END
     INTO v_role_desc
     FROM ma_roles a, MA_USER_ROLES b
    WHERE     A.COMPANY_ID = B.COMPANY_ID
          AND A.ROLE_ID = B.ROLE_ID
          AND B.USER_ID = p_lead_Id
          AND A.COMPANY_ID = p_company_id;


   SELECT muliple_replace_fun (
             v_sub,
             NEW t_text ('Vessel IMO No:__',
                         'Vessel Name: __',
                         'Official No.:___'),
             NEW t_text ('Vessel IMO No:' || p_vesselImo,
                         'Vessel Name:' || vessel_name1,
                         'Official No:' || official_no1)),
          muliple_replace_fun (
             v_bdy,
             NEW t_text ('IMO Number: ___',
                         'Vessel Name: ___',
                         'Official No.: ___',
                         'Company IMO No.:____',
                         'DOC Type & No.:____',
                         'DD-MMM-YYYY',
                         'Auditor/ Manager/ Inspector:__'),
             NEW t_text (
                    'IMO Number: ' || p_vesselImo,
                    'Vessel Name: ' || vessel_name1,
                    'Official No: ' || official_no1,
                    'Company IMO No: ' || v_company_imo_number,
                       'DOC Type & No: '
                    || doc_type1
                    || ' & '
                    || doc_type_number1,
                    v_due_date,
                    v_role_desc || ': ' || v_role_name))
     INTO v_sub1, v_bdy1
     FROM DUAL;
     
   audit_send_mail_prc (
      'Partial Vessel details retrieved from RMI system ' || p_vesselImo,
      p_company_id,
      v_from,
      v_to_mail,
      v_cc_mail,
      v_sub1,
      v_bdy1);
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject, body
        INTO v_sub, v_bdy
        FROM audit_email_dtls
       WHERE email_seq = 29;

      v_err_msg := SQLERRM || ' ' || DBMS_UTILITY.format_error_backtrace;

      audit_send_mail_prc (
         p_audit_no     => 'Partial Vessel details retrieved from RMI system ',
         p_company_id   => p_company_id,
         p_from_mail    => audit_details_pkg.v_From,
         p_to_mail      => audit_details_pkg.V_BSOLTEAM,
         p_subject      => v_sub,
         p_body         => v_err_msg);
END;
/
