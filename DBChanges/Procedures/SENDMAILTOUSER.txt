CREATE OR REPLACE procedure AUDIT_STAG_TEST.sendmailtouser(p_to_mail        IN VARCHAR2,
                                       p_from_mail      IN VARCHAR2,
                                       p_cc_mail varchar2,
                                       p_subject in varchar,
                                       p_body in varchar,
                                        p_smtp_host IN VARCHAR2,
                                       p_smtp_port IN NUMBER DEFAULT 25
)
AS
   l_mail_conn   UTL_SMTP.connection;
   v_user        VARCHAR2 (30);
   v_err_msg     VARCHAR2 (1000);

   PRAGMA AUTONOMOUS_TRANSACTION;

   PROCEDURE process_recipients (p_mail_conn   IN OUT UTL_SMTP.connection,
                                 p_list        IN     VARCHAR2)
   AS
      l_tab   string_api.t_split_array;
   BEGIN
      IF TRIM (p_list) IS NOT NULL
      THEN
         l_tab := string_api.split_text (p_list);

         FOR i IN 1 .. l_tab.COUNT
         LOOP
            UTL_SMTP.rcpt (p_mail_conn, TRIM (l_tab (i)));
         END LOOP;
      END IF;
   END;
BEGIN
--Code to send email--
   l_mail_conn := UTL_SMTP.open_connection (p_smtp_host, p_smtp_port);
   UTL_SMTP.helo (l_mail_conn, p_smtp_host);
   UTL_SMTP.mail (l_mail_conn, p_from_mail);
   process_recipients (l_mail_conn, p_to_mail);
   process_recipients (l_mail_conn, p_cc_mail);
   --  process_recipients(l_mail_conn, p_bcc);

   UTL_SMTP.open_data (l_mail_conn);

   UTL_SMTP.write_data (
      l_mail_conn,
      'Date: ' || TO_CHAR (SYSDATE, 'DD-MON-YYYY HH24:MI:SS') || UTL_TCP.crlf);
   UTL_SMTP.write_data (l_mail_conn, 'To: ' || p_to_mail || UTL_TCP.crlf);


   UTL_SMTP.write_data (l_mail_conn, 'From: ' || p_from_mail || UTL_TCP.crlf);
   UTL_SMTP.write_data (l_mail_conn,
                        'Subject: ' || p_subject || UTL_TCP.crlf);
   --   UTL_SMTP.write_data (
   --      l_mail_conn,
   --      'Reply-To: ' || p_from_mail || UTL_TCP.crlf || UTL_TCP.crlf);

   UTL_SMTP.write_data (l_mail_conn, p_body || UTL_TCP.crlf || UTL_TCP.crlf);
   UTL_SMTP.close_data (l_mail_conn);

   UTL_SMTP.quit (l_mail_conn);

   --end of sending mail--
   end;
/
