CREATE OR REPLACE PROCEDURE AUDIT_STAG_TEST.AUD_CREATE_MAIL_SEND_PRC (
   p_auditno          NUMBER,
   p_audit_type_id    NUMBER,
   p_companyid        NUMBER)
AS
   v_admin                  VARCHAR2 (200 BYTE);
   v_from                   VARCHAR2 (30) := audit_details_pkg.v_from;
   v_to                     VARCHAR2 (10000);
   v_cc                     VARCHAR2 (10000);  --:= audit_details_pkg.v_admin;
   v_subject                VARCHAR2 (200);
   v_body                   VARCHAR2 (1000);
   v_sub                    VARCHAR2 (200);
   v_bdy                    VARCHAR2 (1000);
   v_user_ins               VARCHAR2 (100);
   v_vessel_imo_no          NUMBER;
   v_certificate_issue_id   VARCHAR2 (100);
   v_audit_subtype_id       VARCHAR2 (100);
   v_err_msg                VARCHAR2 (1000);
   v_role_id                NUMBER (10);
   V_MRG                    VARCHAR2 (500);
   audit_desc_msg           VARCHAR2 (20);
   vInsRole                 NUMBER;
   vRole                    VARCHAR2 (30);
   vAuditor                 VARCHAR2 (30);
   vAudRoleId               NUMBER;
   vAudLeadStatus           NUMBER;
   vAudTypeId               NUMBER;
   v_lead_audit             VARCHAR2 (100);
   vTo                      VARCHAR2 (1000);
   vMgr                     VARCHAR2 (1000);
   vAccssLink               VARCHAR2 (1000);
   vVslImoNo                VARCHAR2 (30);
   v_vessel_name            VARCHAR2 (200);
   v_official_no            NUMBER;


   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   DBMS_OUTPUT.put_line (audit_details_pkg.v_from);

   SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 AND company_id = p_companyid;

   SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO V_MRG
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1003 AND company_id = p_companyid;

   v_cc := v_admin || ',' || V_MRG;

   SELECT subject, body
     INTO v_sub, v_bdy
     FROM audit_email_dtls
    WHERE email_seq = 4;

   DBMS_OUTPUT.put_line ('1' || v_sub);

   SELECT ADT.VESSEL_IMO_NO,
          ADT.AUDIT_SUB_TYPE_ID,
          ADT.CERTIFICATE_ISSUE_ID,
          ADT.USER_INS
     INTO v_vessel_imo_no,
          v_audit_subtype_id,
          v_certificate_issue_id,
          v_user_ins
     FROM AUDIT_DETAILS ADT
    WHERE     ADT.AUDIT_TYPE_ID = p_audit_type_id
          AND ADT.AUDIT_SEQ_NO = p_auditno
          AND ADT.COMPANY_ID = p_companyid;

   SELECT COUNT (*)
     INTO v_role_id
     FROM MA_USER_ROLES USRL
    WHERE USRL.USER_ID = v_user_ins AND USRL.ROLE_ID = 1001;

   IF p_audit_type_id IN (1004, 1005)
   THEN
      audit_desc_msg := 'Review';
   ELSIF p_audit_type_id IN (1003)
   THEN
      audit_desc_msg := 'Inspection';
   ELSE
      audit_desc_msg := 'Audit';
   END IF;


   IF v_role_id > 0
   THEN
      SELECT muliple_replace_fun (
                v_sub,
                NEW t_text ('Audit (Type:__, Subtype:___)',
                            'Vessel: ___',
                            'IMO No.:__',
                            'and Official No.:___'),
                NEW t_text (
                          audit_desc_msg
                       || '(Type: '
                       || audit_type_desc
                       || ', Sub Type: '
                       || audit_subtype_desc
                       || ')',
                       'Vessel: ' || v_vessel_name,
                       'IMO No: ' || v_vessel_imo_no,
                       '& Official No: ' || v_official_no)),
             muliple_replace_fun (
                v_bdy,
                NEW t_text ('Audit type__',
                            'Audit Subtype__',
                            'Vessel:___',
                            'IMO No__',
                            'and Official No.:___',
                            'by__'),
                NEW t_text (
                       audit_desc_msg || ' type: ' || audit_type_desc,
                       audit_desc_msg || '  Subtype: ' || audit_subtype_desc,
                       'Vessel: ' || v_vessel_name,
                       'IMO No: ' || v_vessel_imo_no,
                       '& Official No: ' || v_official_no,
                       'by ' || user_name))
        INTO v_subject, v_body
        FROM (SELECT (SELECT maud.audit_type_desc
                        FROM ma_audit_type maud
                       WHERE maud.audit_type_id = p_audit_type_id
                             AND maud.company_id = p_companyid)
                        audit_type_desc,
                     (SELECT msub.audit_subtype_desc
                        FROM ma_audit_subtype msub
                       WHERE     msub.audit_sub_type_id = v_audit_subtype_id
                             AND msub.audit_type_id = p_audit_type_id
                             AND msub.company_id = p_companyid)
                        audit_subtype_desc,
                     (SELECT VESSEL_NAME
                        FROM MA_VESSEL
                       WHERE VESSEL_IMO_NO = v_vessel_imo_no
                             AND COMPANY_ID = p_companyid)
                        v_vessel_name,
                     (SELECT OFFICIAL_NO
                        FROM MA_VESSEL
                       WHERE VESSEL_IMO_NO = v_vessel_imo_no
                             AND COMPANY_ID = p_companyid)
                        v_official_no,
                     (SELECT first_name || ' ' || last_name
                        FROM ma_users mu
                       WHERE mu.user_id = v_user_ins
                             AND mu.company_id = p_companyid)
                        user_name
                FROM DUAL) test;

      SELECT listagg (aud.user_id, ',')
                WITHIN GROUP (ORDER BY aud.audit_seq_no)
        INTO v_to
        FROM audit_auditor_details aud
       WHERE aud.audit_role_id IN
                (SELECT audit_role_id
                   FROM ma_audit_roles
                  WHERE REGEXP_LIKE (audit_role_desc,
                                     'AUDITOR|OBSERVER|REVIEWER')
                        AND company_id = p_companyid)
             AND aud.audit_seq_no = p_auditno
             AND AUD.AUDIT_TYPE_ID = p_audit_type_id
             AND aud.company_id = p_companyid;

      audit_send_mail_prc ('New ' || audit_desc_msg || ' ' || p_auditno,
                           p_companyid,
                           v_from,
                           v_to,
                           v_cc,
                           v_subject,
                           v_body);
   /*
         FOR i IN (SELECT user_id,
                          audit_role_id,
                          aud_lead_status,
                          audit_type_id,
                          user_ins
                     FROM AUDIT_AUDITOR_DETAILS
                    WHERE Audit_seq_no = p_auditno AND company_id = p_companyid)
         LOOP
            v_to := i.user_id;
            vAudRoleId := i.audit_role_id;
            vAudLeadStatus := i.aud_lead_status;
            vAudTypeId := i.audit_type_id;
            v_user_ins := i.user_ins;

            SELECT subject, body
              INTO v_subject, v_body
              FROM audit_email_dtls
             WHERE email_seq = 52;

            CASE
               WHEN vAudRoleId = 1001 AND vAudLeadStatus = 0
               THEN
                  vAuditor := 'Auditor';
               WHEN vAudRoleId = 1001 AND vAudLeadStatus = 1
               THEN
                  IF vAudTypeId IN (1003)
                  THEN
                     vAuditor := 'Lead Inspector';
                  ELSE
                     vAuditor := 'Lead Auditor';
                  END IF;
               WHEN vAudRoleId = 1003 AND vAudLeadStatus = 0
               THEN
                  vAuditor := 'Reviewer';
               WHEN vAudRoleId = 1002 AND vAudLeadStatus = 0
               THEN
                  vAuditor := 'Observer';
               ELSE
                  vAuditor := 'null';
            END CASE;

            IF vAudLeadStatus <> 1
            THEN
               SELECT user_id
                 INTO v_lead_audit
                 FROM audit_auditor_details
                WHERE     audit_seq_no = p_auditno
                      AND audit_role_id = 1001
                      AND aud_lead_status = 1
                      AND audit_type_id = vAudTypeId;
            END IF;

            SELECT role_id
              INTO vInsRole
              FROM ma_user_roles
             WHERE user_id = v_user_ins AND company_id = p_companyid;

            CASE
               WHEN vInsRole = 1001
               THEN
                  vRole := 'Lead';
               WHEN vInsRole = 1002
               THEN
                  vRole := 'Admin';
               WHEN vInsRole = 1003
               THEN
                  vRole := 'Manager';
            END CASE;

            IF vAudTypeId IN (1004, 1005)
            THEN
               audit_desc_msg := 'Review';
            ELSIF vAudTypeId IN (1003)
            THEN
               audit_desc_msg := 'Inspection';
            ELSIF vAudTypeId IN (1001, 1002)
            THEN
               audit_desc_msg := 'Audit';
            END IF;

            SELECT muliple_replace_fun (
                      v_subject,
                      NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                                  'Audit___',
                                  'IMO No.___'),
                      NEW t_text (vAuditor,
                                  audit_desc_msg || ' Type : ' || vAudType,
                                  'IMO ' || 'No: ' || vVslImoNo)),
                   muliple_replace_fun (
                      v_body,
                      NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                                  'Audit Sub type:___',
                                  'Audit Type: ____',
                                  'IMO No.___',
                                  ' ___(New)___',
                                  'by the__'),
                      NEW t_text (
                             vAuditor,
                             audit_desc_msg || ' Sub Type: ' || vAudSubType,
                             audit_desc_msg || ' Type :' || vAudType,
                             'IMO No: ' || vVslImoNo,
                             ' ' || v_user_Name || ' ',
                             'by ' || 'the ' || vRole))
              INTO v_sub, v_bdy
              FROM (SELECT (SELECT audit_type_desc
                              FROM ma_audit_type
                             WHERE audit_type_id = vAudTypeId
                                   AND company_id = p_companyid)
                              vAudType,
                           (SELECT vessel_imo_no
                              FROM audit_details
                             WHERE audit_seq_no = p_auditno
                                   AND company_id = p_companyid)
                              vVslImoNo,
                           (SELECT b.audit_subtype_desc
                              FROM audit_details a, ma_audit_subtype b
                             WHERE     a.audit_type_id = b.audit_type_id
                                   AND a.audit_sub_type_id = b.audit_sub_type_id
                                   AND a.company_id = b.company_id
                                   AND a.audit_seq_no = p_auditno
                                   AND a.company_id = p_companyid)
                              vAudSubType,
                           (SELECT first_name || ' ' || last_name
                              FROM ma_users
                             WHERE USER_ID = v_to AND company_id = p_companyid)
                              v_user_Name
                      FROM DUAL) test;

            SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
              INTO vMgr
              FROM MA_USER_ROLES USRL
             WHERE USRL.ROLE_ID = 1003 AND company_id = p_companyid;

            SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
              INTO v_admin
              FROM MA_USER_ROLES USRL
             WHERE USRL.ROLE_ID = 1002 AND company_id = p_companyid;

            IF (vAuditor <> 'Lead Auditor' AND vAuditor <> 'Lead Inspector')
            THEN
               v_cc := v_lead_audit || ',' || vMgr || ',' || v_admin;
            ELSE
               v_cc := vMgr || ',' || v_admin;
            END IF;

            vAccssLink :=
                  vAuditor
               || ' Added for the ' || audit_desc_msg
               || ' with  vessel imo no  '
               || vVslImoNo
               || 'WIth Audit seq no  '
               || p_auditno;

            audit_send_mail_prc (vAccssLink,
                                 p_companyid,
                                 v_from,
                                 v_to,
                                 v_cc,
                                 v_sub,
                                 v_bdy);
         END LOOP;

   */
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject
        INTO v_sub
        FROM audit_email_dtls
       WHERE email_seq = 4;

      v_err_msg := SQLERRM || ' ' || DBMS_UTILITY.format_error_backtrace;

      INSERT INTO audit_email_log_dtls (email_seq,
                                        access_link,
                                        from_mail,
                                        to_mail,
                                        cc_mail,
                                        subject,
                                        MESSAGE,
                                        status,
                                        error_message,
                                        company_id,
                                        user_ins)
           VALUES (audit_email_dtls_seq.NEXTVAL,
                   p_auditno,
                   v_from,
                   v_to,
                   v_cc,
                   v_subject,
                   v_body,
                   'Failed',
                   v_err_msg,
                   p_companyid,
                   'admin');

      COMMIT;
      audit_send_mail_prc (p_audit_no     => 'New Audit Created',
                           p_company_id   => p_companyid,
                           p_from_mail    => audit_details_pkg.v_From,
                           p_to_mail      => audit_details_pkg.V_BSOLTEAM,
                           p_subject      => v_sub,
                           p_body         => v_err_msg);
END;
/
