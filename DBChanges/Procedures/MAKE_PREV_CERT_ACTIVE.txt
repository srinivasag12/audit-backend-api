CREATE OR REPLACE PROCEDURE LOCAL_AUDIT_CHANGES.MAKE_PREV_CERT_ACTIVE (
  
   p_vessel_imo_no AUDIT_DETAILS.VESSEL_IMO_NO%TYPE,
   p_audit_type_id       AUDIT_DETAILS.AUDIT_TYPE_ID%TYPE,
   p_audit_seq_no        AUDIT_DETAILS.AUDIT_SEQ_NO%TYPE,
   p_certificate_no       AUDIT_DETAILS.CERTIFICATE_NO%TYPE,
   p_audit_summary_id AUDIT_DETAILS.AUDIT_SUMMARY_ID%TYPE,
   p_audit_status_id AUDIT_DETAILS.AUDIT_STATUS_ID%TYPE,
   p_audit_subtype_id AUDIT_DETAILS.AUDIT_SUB_TYPE_ID%TYPE,
   p_certificate_issue_id AUDIT_DETAILS.CERTIFICATE_ISSUE_ID%TYPE
 )
   
  AS
 v_audit_seq_no AUDIT_DETAILS.AUDIT_SEQ_NO%TYPE;
  v_seq_no CERTIFICATE_DETAIL.SEQ_NO%TYPE;
  v_publish_status CERTIFICATE_DETAIL.PUBLISH_STATUS%TYPE;
  v_audit_summary_id AUDIT_DETAILS.AUDIT_SUMMARY_ID%TYPE;
  v_prev_cert_issue_id AUDIT_DETAILS.CERTIFICATE_ISSUE_ID%TYPE;
  v_prev_aud_type_id AUDIT_DETAILS.AUDIT_SUB_TYPE_ID%TYPE;
  v_prev_full_term_audit_seq_no AUDIT_DETAILS.AUDIT_SEQ_NO%TYPE;
  v_current_cert_issue_id AUDIT_DETAILS.CERTIFICATE_ISSUE_ID%TYPE;
  v_prev_audit_seq_no AUDIT_DETAILS.AUDIT_SEQ_NO%TYPE;
  v_count NUMBER;
   
   BEGIN 
   
   
    dbms_output.put_line('demos');
    
        IF p_audit_subtype_id IN (1003,1005)
        
        THEN 
            SELECT CERTIFICATE_ISSUE_ID
            INTO v_current_cert_issue_id
                            FROM CERTIFICATE_DETAIL 
                            WHERE VESSEL_IMO_NO = p_vessel_imo_no
                            AND AUDIT_TYPE_ID= p_audit_type_id
                            AND AUDIT_SEQ_NO = p_audit_seq_no
                            AND SEQ_NO = (SELECT MAX(SEQ_NO)
                            FROM CERTIFICATE_DETAIL 
                            WHERE AUDIT_SEQ_NO= p_audit_seq_no);
                            
             ELSE IF p_audit_subtype_id IN (1001,1002,1004)
             THEN
             
              v_current_cert_issue_id :=p_certificate_issue_id;
             
             END IF;
    
    
      END IF;
   
   SELECT PUBLISH_STATUS
   INTO v_publish_status
   FROM CERTIFICATE_DETAIL
   WHERE VESSEL_IMO_NO = p_vessel_imo_no
   AND AUDIT_TYPE_ID = p_audit_type_id
   AND AUDIT_SEQ_NO = p_audit_seq_no
   AND CERTIFICATE_NO = p_certificate_no
   AND SEQ_NO IN (SELECT MAX(SEQ_NO)
   FROM CERTIFICATE_DETAIL
   WHERE VESSEL_IMO_NO = p_vessel_imo_no
   AND AUDIT_TYPE_ID = p_audit_type_id
   AND AUDIT_SEQ_NO = p_audit_seq_no
   AND CERTIFICATE_NO = p_certificate_no);
   
   
   
   SELECT AUDIT_SUMMARY_ID
   INTO  v_audit_summary_id
   FROM AUDIT_DETAILS 
   WHERE VESSEL_IMO_NO = p_vessel_imo_no
   AND AUDIT_TYPE_ID = p_audit_type_id
   AND AUDIT_SEQ_NO = p_audit_seq_no;
   dbms_output.put_line('demo2');
    /* */
       SELECT AUDIT_SUB_TYPE_ID
                     INTO v_prev_aud_type_id
                      FROM AUDIT_DETAILS
                      WHERE AUDIT_SEQ_NO IN(
                      SELECT MAX(AUDIT_SEQ_NO)
                      FROM AUDIT_DETAILS
                      WHERE VESSEL_IMO_NO = p_vessel_imo_no
                      AND AUDIT_TYPE_ID = p_audit_type_id
                      AND AUDIT_STATUS_ID <> 1004
                      AND AUDIT_SUMMARY_ID <> 1005
                      AND AUDIT_SEQ_NO < p_audit_seq_no);
           /* */ 
           dbms_output.put_line('demo3');          
     /*   */
      IF v_prev_aud_type_id IN (1003,1005)
      THEN 
        SELECT CERTIFICATE_ISSUE_ID
           INTO v_prev_cert_issue_id
           FROM CERTIFICATE_DETAIL
           WHERE AUDIT_SEQ_NO IN(
           SELECT MAX(AUDIT_SEQ_NO)
           FROM AUDIT_DETAILS
           WHERE VESSEL_IMO_NO = p_vessel_imo_no
           AND AUDIT_TYPE_ID = p_audit_type_id
           AND AUDIT_STATUS_ID <> 1004
           AND AUDIT_SUMMARY_ID <> 1005
           AND AUDIT_SEQ_NO < p_audit_seq_no)
           AND SEQ_NO IN (SELECT MAX(SEQ_NO)
           FROM CERTIFICATE_DETAIL
           WHERE AUDIT_SEQ_NO IN(
           SELECT MAX(AUDIT_SEQ_NO)
           FROM AUDIT_DETAILS
           WHERE VESSEL_IMO_NO = p_vessel_imo_no
           AND AUDIT_TYPE_ID = p_audit_type_id
           AND AUDIT_STATUS_ID <> 1004
           AND AUDIT_SUMMARY_ID <> 1005
           AND AUDIT_SEQ_NO < p_audit_seq_no));
           
             ELSE IF  v_prev_aud_type_id IN (1001,1002,1004)
           
             THEN 
             
             dbms_output.put_line('demo4');  
            SELECT CERTIFICATE_ISSUE_ID
           INTO v_prev_cert_issue_id
           FROM AUDIT_DETAILS
           WHERE AUDIT_SEQ_NO IN(
           SELECT MAX(AUDIT_SEQ_NO)
           FROM AUDIT_DETAILS
           WHERE VESSEL_IMO_NO = p_vessel_imo_no
           AND AUDIT_TYPE_ID = p_audit_type_id
           AND AUDIT_STATUS_ID <> 1004
           AND AUDIT_SUMMARY_ID <> 1005
           AND AUDIT_SEQ_NO < p_audit_seq_no);
           
           END IF;
           
    END IF;
    /*  */
    dbms_output.put_line('demo3');
            dbms_output.put_line(v_prev_cert_issue_id);
             dbms_output.put_line(p_certificate_issue_id);
   
     IF (p_audit_Status_id = 1004) AND (v_prev_cert_issue_id<>1003) AND (v_current_cert_issue_id<>1003)
   
      THEN
      dbms_output.put_line('=====================================');
                 IF  p_audit_subtype_id IN (1003,1005)
      
                 THEN 
                   SELECT AUDIT_SEQ_NO, SEQ_NO 
                   INTO v_audit_seq_no, v_seq_no 
                   FROM(
                   SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                   FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                   ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                  WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                  AND C.AUDIT_TYPE_ID = p_audit_type_id  
                  AND C.AUDIT_SEQ_NO < p_audit_seq_no
                  AND A.AUDIT_STATUS_ID <> 1004
                  AND A.AUDIT_SUMMARY_ID <> 1005
                  AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                  FROM CERTIFICATE_DETAIL 
                  WHERE VESSEL_IMO_NO = p_vessel_imo_no
                  AND AUDIT_TYPE_ID = p_audit_type_id  
                  AND AUDIT_SEQ_NO <p_audit_seq_no
                  AND CERTIFICATE_NO IN (SELECT MIN(CERTIFICATE_NO)
                  FROM CERTIFICATE_DETAIL
                 WHERE VESSEL_IMO_NO = p_vessel_imo_no
                 AND AUDIT_TYPE_ID = p_audit_type_id
                 AND AUDIT_SEQ_NO =p_audit_seq_no)
                 GROUP BY AUDIT_SEQ_NO
                         )
                 ORDER BY C.AUDIT_SEQ_NO DESC)
                WHERE ROWNUM =1;
                dbms_output.put_line('=0=0===00==0=000=00=0=0==0');
            
                 ELSE IF   p_audit_subtype_id IN (1001,1002,1004)
         
                  THEN 
                   dbms_output.put_line('000000000000000000000000000000000000000000000000000000000000000000000');
                    SELECT AUDIT_SEQ_NO
                    INTO v_audit_seq_no
                    FROM(
                    SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                    FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                    ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                    WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                    AND C.AUDIT_TYPE_ID = p_audit_type_id  
                    AND C.AUDIT_SEQ_NO < p_audit_seq_no
                    AND A.AUDIT_STATUS_ID <> 1004
                    AND A.AUDIT_SUMMARY_ID <> 1005
                    AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                    FROM CERTIFICATE_DETAIL 
                    WHERE VESSEL_IMO_NO = p_vessel_imo_no
                    AND AUDIT_TYPE_ID = p_audit_type_id  
                    AND AUDIT_SEQ_NO <p_audit_seq_no
                    GROUP BY AUDIT_SEQ_NO
                       )
                    ORDER BY C.AUDIT_SEQ_NO DESC)
                    WHERE ROWNUM =1;
            
            
                   SELECT MAX(SEQ_NO)
                   INTO v_seq_no
                   FROM CERTIFICATE_DETAIL
                   WHERE AUDIT_SEQ_NO = v_audit_seq_no;
            
                 END IF;
                 
                  dbms_output.put_line('111111111111111111111111111111111111');
      
             END IF; 
              
      
      dbms_output.put_line(v_audit_seq_no); 
      dbms_output.put_line(v_seq_no); 
      UPDATE CERTIFICATE_DETAIL 
      SET ACTIVE_STATUS=1
      WHERE AUDIT_SEQ_NO =v_audit_seq_no
      AND SEQ_NO = v_seq_no;
      
      END IF;
      
      IF  (v_prev_cert_issue_id<>1003) AND (v_current_cert_issue_id=1003)
        
        THEN
         dbms_output.put_line('all is well+++++++++++++++++++++++++++++++++++++++'); 
        dbms_output.put_line('test1'); 
                    UPDATE CERTIFICATE_DETAIL
                    SET ACTIVE_STATUS =1
                    WHERE AUDIT_SEQ_NO =(
                       SELECT MAX(AUDIT_SEQ_NO)
                       FROM AUDIT_DETAILS
                       WHERE VESSEL_IMO_NO = p_vessel_imo_no
                       AND AUDIT_TYPE_ID = p_audit_type_id
                       AND AUDIT_STATUS_ID <> 1004
                       AND AUDIT_SUMMARY_ID <> 1005
                       AND AUDIT_SEQ_NO < p_audit_seq_no)
                       AND SEQ_NO = (SELECT MAX(SEQ_NO)
                       FROM CERTIFICATE_DETAIL
                       WHERE AUDIT_SEQ_NO =( SELECT MAX(AUDIT_SEQ_NO)
                       FROM AUDIT_DETAILS
                       WHERE VESSEL_IMO_NO = p_vessel_imo_no
                       AND AUDIT_TYPE_ID = p_audit_type_id
                       AND AUDIT_STATUS_ID <> 1004
                       AND AUDIT_SUMMARY_ID <> 1005
                       AND AUDIT_SEQ_NO < p_audit_seq_no));
                       
                       dbms_output.put_line('test2'); 
                       
              ELSE IF ( (v_prev_cert_issue_id=1003) AND (v_current_cert_issue_id=1003) OR (v_prev_cert_issue_id=1003) AND (v_current_cert_issue_id<>1003))
                   THEN
                    dbms_output.put_line('all is well************************************'); 
                   
                    
                      
                       IF  v_prev_aud_type_id  IN (1003,1005)
                       
                       THEN 
                       dbms_output.put_line('all is well2'); 
                           SELECT MAX(A.AUDIT_SEQ_NO)
                           INTO v_prev_full_term_audit_seq_no 
                           FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                           ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                           WHERE A.VESSEL_IMO_NO = p_vessel_imo_no
                            AND A.AUDIT_TYPE_ID= p_audit_type_id
                            AND A.AUDIT_SEQ_NO < p_audit_seq_no
                            AND A.AUDIT_SUMMARY_ID<>1005
                            AND A.AUDIT_STATUS_ID <> 1004
                            AND A.AUDIT_SUB_TYPE_ID NOT IN (1003,1005)
                            AND C.CERTIFICATE_NO = (SELECT  CERTIFICATE_NO
                            FROM AUDIT_DETAILS
                            WHERE AUDIT_SEQ_NO = (SELECT MAX(AUDIT_SEQ_NO)
                            FROM AUDIT_DETAILS
                            WHERE VESSEL_IMO_NO = p_vessel_imo_no
                            AND AUDIT_TYPE_ID= p_audit_type_id
                            AND AUDIT_SEQ_NO < p_audit_seq_no
                            AND AUDIT_SUMMARY_ID<>1005
                            AND AUDIT_STATUS_ID <>1004));
                            
                            dbms_output.put_line('all is well3'); 
                            
                          FOR I IN (SELECT AUDIT_SEQ_NO
                            FROM AUDIT_DETAILS
                            WHERE AUDIT_SEQ_NO>=v_prev_full_term_audit_seq_no
                            AND AUDIT_SEQ_NO <p_audit_seq_no
                            AND VESSEL_IMO_NO = p_vessel_imo_no
                            AND AUDIT_TYPE_ID = p_audit_type_id
                            AND AUDIT_SUMMARY_ID <> 1005
                            AND AUDIT_STATUS_ID<>1004)
                           
                          
                           LOOP
                            dbms_output.put_line(I.AUDIT_SEQ_NO);
                            UPDATE CERTIFICATE_DETAIL
                            SET ACTIVE_STATUS=1
                            WHERE AUDIT_SEQ_NO = I.AUDIT_SEQ_NO
                            AND SEQ_NO = (SELECT MAX(SEQ_NO)
                            FROM CERTIFICATE_DETAIL
                            WHERE AUDIT_SEQ_NO = I.AUDIT_SEQ_NO);
                            
                            END LOOP;
                            
                            
                            
                            ELSE IF v_prev_aud_type_id  IN (1001,1002,1004)
                              
                              THEN 
                                dbms_output.put_line('all is well---------------------------------------------------------------------------------'); 
                              SELECT MAX(AUDIT_SEQ_NO)
                              INTO v_prev_audit_seq_no
                              FROM AUDIT_DETAILS
                              WHERE VESSEL_IMO_NO=p_vessel_imo_no
                              AND AUDIT_TYPE_ID = p_audit_type_id
                              AND AUDIT_SUMMARY_ID <> 1005
                              AND AUDIT_STATUS_ID <> 1004
                              AND AUDIT_SEQ_NO < p_audit_seq_no;
                              
                              /*SELECT COUNT(*)
                              INTO v_count
                                   FROM CERTIFICATE_DETAIL 
                                   WHERE VESSEL_IMO_NO=p_vessel_imo_no
                                   AND AUDIT_TYPE_ID = p_audit_type_id
                                   AND AUDIT_SEQ_NO = v_prev_audit_seq_no;*/
                            
                              
                             /* IF ( v_count <=2)*/
                                   
                                   /*THEN */
                                   
                                   UPDATE CERTIFICATE_DETAIL
                                   SET ACTIVE_STATUS = 1
                                   WHERE  VESSEL_IMO_NO=p_vessel_imo_no
                                   AND AUDIT_TYPE_ID = p_audit_type_id
                                   AND AUDIT_SEQ_NO = v_prev_audit_seq_no
                                   AND SEQ_NO = (SELECT MAX(SEQ_NO)
                                   FROM CERTIFICATE_DETAIL
                                   WHERE  VESSEL_IMO_NO=p_vessel_imo_no
                                   AND AUDIT_TYPE_ID = p_audit_type_id
                                   AND AUDIT_SEQ_NO = v_prev_audit_seq_no);
                                   
                                   
                                   UPDATE CERTIFICATE_DETAIL
                                   SET ACTIVE_STATUS = 0
                                   WHERE  VESSEL_IMO_NO=p_vessel_imo_no
                                   AND AUDIT_TYPE_ID = p_audit_type_id
                                   AND AUDIT_SEQ_NO = v_prev_audit_seq_no
                                   AND SEQ_NO NOT IN (SELECT MAX(SEQ_NO)
                                   FROM CERTIFICATE_DETAIL
                                   WHERE  VESSEL_IMO_NO=p_vessel_imo_no
                                   AND AUDIT_TYPE_ID = p_audit_type_id
                                   AND AUDIT_SEQ_NO = v_prev_audit_seq_no)
                                   AND ACTIVE_STATUS = 1;
                                   
                                    dbms_output.put_line('all is well----------------------------------++++++++++++++++++++++++++++++++++****************************'); 
                              
                              /*END IF;*/
                              
                               
                            
                            
                            END IF;
                         
                       
                       END IF;
                       
                       
                       
               END IF;
        
        END IF;
      
    /*  IF p_audit_summary_id = 1005  AND v_publish_status =1 AND p_audit_status_id <> 1004
      
      
      THEN 
      
           IF p_audit_subtype_id IN (1003,1005)
        
           THEN
        
                SELECT AUDIT_SEQ_NO, SEQ_NO 
                   INTO v_audit_seq_no, v_seq_no 
                   FROM(
                   SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                   FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                   ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                  WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                  AND C.AUDIT_TYPE_ID = p_audit_type_id  
                  AND C.AUDIT_SEQ_NO < p_audit_seq_no
                  AND A.AUDIT_STATUS_ID <> 1004
                  AND A.AUDIT_SUMMARY_ID <> 1005
                  AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                  FROM CERTIFICATE_DETAIL 
                  WHERE VESSEL_IMO_NO = p_vessel_imo_no
                  AND AUDIT_TYPE_ID = p_audit_type_id  
                  AND AUDIT_SEQ_NO <p_audit_seq_no
                  AND CERTIFICATE_NO IN (SELECT MIN(CERTIFICATE_NO)
                  FROM CERTIFICATE_DETAIL
                 WHERE VESSEL_IMO_NO = p_vessel_imo_no
                 AND AUDIT_TYPE_ID = p_audit_type_id
                 AND AUDIT_SEQ_NO =p_audit_seq_no)
                 GROUP BY AUDIT_SEQ_NO
                         )
                 ORDER BY C.AUDIT_SEQ_NO DESC)
                WHERE ROWNUM =1;
                
                
                UPDATE CERTIFICATE_DETAIL 
                SET ACTIVE_STATUS=1
                WHERE AUDIT_SEQ_NO =v_audit_seq_no
                AND SEQ_NO = v_seq_no;
             
                  UPDATE CERTIFICATE_DETAIL
                 SET ACTIVE_STATUS = 0
                WHERE VESSEL_IMO_NO = p_vessel_imo_no
               AND AUDIT_SEQ_NO = p_audit_seq_no 
               AND AUDIT_TYPE_ID = p_audit_type_id
               AND CERTIFICATE_NO = p_certificate_no
               AND SEQ_NO IN (SELECT MAX(SEQ_NO)
               FROM CERTIFICATE_DETAIL
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
                AND AUDIT_TYPE_ID = p_audit_type_id 
                AND AUDIT_SEQ_NO =p_audit_seq_no 
                AND CERTIFICATE_NO = p_certificate_no);
                
                   ELSE IF   p_audit_subtype_id IN (1001,1002,1004)
                   
                   THEN 
                   
                          SELECT AUDIT_SEQ_NO
                    INTO v_audit_seq_no
                    FROM(
                    SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                    FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                    ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                    WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                    AND C.AUDIT_TYPE_ID = p_audit_type_id  
                    AND C.AUDIT_SEQ_NO < p_audit_seq_no
                    AND A.AUDIT_STATUS_ID <> 1004
                    AND A.AUDIT_SUMMARY_ID <> 1005
                    AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                    FROM CERTIFICATE_DETAIL 
                    WHERE VESSEL_IMO_NO = p_vessel_imo_no
                    AND AUDIT_TYPE_ID = p_audit_type_id  
                    AND AUDIT_SEQ_NO <p_audit_seq_no
                    GROUP BY AUDIT_SEQ_NO
                       )
                    ORDER BY C.AUDIT_SEQ_NO DESC)
                    WHERE ROWNUM =1;
            
            
                   SELECT MAX(SEQ_NO)
                   INTO v_seq_no
                   FROM CERTIFICATE_DETAIL
                   WHERE AUDIT_SEQ_NO = v_audit_seq_no;
                   
                        UPDATE CERTIFICATE_DETAIL 
                       SET ACTIVE_STATUS=1
                       WHERE AUDIT_SEQ_NO =v_audit_seq_no
                       AND SEQ_NO = v_seq_no;
             
                       UPDATE CERTIFICATE_DETAIL
                      SET ACTIVE_STATUS = 0
                      WHERE VESSEL_IMO_NO = p_vessel_imo_no
                      AND AUDIT_SEQ_NO = p_audit_seq_no 
                      AND AUDIT_TYPE_ID = p_audit_type_id
                      AND CERTIFICATE_NO = p_certificate_no
                      AND SEQ_NO IN (SELECT MAX(SEQ_NO)
                      FROM CERTIFICATE_DETAIL
                      WHERE VESSEL_IMO_NO = p_vessel_imo_no
                      AND AUDIT_TYPE_ID = p_audit_type_id 
                      AND AUDIT_SEQ_NO =p_audit_seq_no 
                      AND CERTIFICATE_NO = p_certificate_no);
                   
                   END IF;
        
            END IF;
      
       
               
                 ELSE IF p_audit_summary_id <> 1005 AND  v_publish_status =1 AND p_audit_Status_id <> 1004
      
                THEN
             
             
             IF   p_audit_subtype_id IN (1003,1005)
             
               THEN 
               
                   SELECT AUDIT_SEQ_NO, SEQ_NO 
                   INTO v_audit_seq_no, v_seq_no 
                   FROM(
                   SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                   FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                   ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                  WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                  AND C.AUDIT_TYPE_ID = p_audit_type_id  
                  AND C.AUDIT_SEQ_NO < p_audit_seq_no
                  AND A.AUDIT_STATUS_ID <> 1004
                  AND A.AUDIT_SUMMARY_ID <> 1005
                  AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                  FROM CERTIFICATE_DETAIL 
                  WHERE VESSEL_IMO_NO = p_vessel_imo_no
                  AND AUDIT_TYPE_ID = p_audit_type_id  
                  AND AUDIT_SEQ_NO <p_audit_seq_no
                  AND CERTIFICATE_NO IN (SELECT MIN(CERTIFICATE_NO)
                  FROM CERTIFICATE_DETAIL
                 WHERE VESSEL_IMO_NO = p_vessel_imo_no
                 AND AUDIT_TYPE_ID = p_audit_type_id
                 AND AUDIT_SEQ_NO =p_audit_seq_no)
                 GROUP BY AUDIT_SEQ_NO
                         )
                 ORDER BY C.AUDIT_SEQ_NO DESC)
                WHERE ROWNUM =1;
                
               
               
                       ELSE IF p_audit_subtype_id IN (1001,1002,1004)
                            THEN 
                            
                            
                             SELECT AUDIT_SEQ_NO
                              INTO v_audit_seq_no
                              FROM(
                              SELECT A.AUDIT_SEQ_NO, C.SEQ_NO
                              FROM AUDIT_DETAILS A INNER JOIN CERTIFICATE_DETAIL C
                             ON (A.AUDIT_SEQ_NO = C.AUDIT_SEQ_NO AND A.AUDIT_TYPE_ID = C.AUDIT_TYPE_ID AND A.VESSEL_IMO_NO =C.VESSEL_IMO_NO )
                             WHERE C.VESSEL_IMO_NO = p_vessel_imo_no
                             AND C.AUDIT_TYPE_ID = p_audit_type_id  
                             AND C.AUDIT_SEQ_NO < p_audit_seq_no
                             AND A.AUDIT_STATUS_ID <> 1004
                             AND A.AUDIT_SUMMARY_ID <> 1005
                             AND C.SEQ_NO IN (SELECT MAX(SEQ_NO)
                             FROM CERTIFICATE_DETAIL 
                             WHERE VESSEL_IMO_NO = p_vessel_imo_no
                             AND AUDIT_TYPE_ID = p_audit_type_id  
                             AND AUDIT_SEQ_NO <p_audit_seq_no
                             GROUP BY AUDIT_SEQ_NO
                             )
                            ORDER BY C.AUDIT_SEQ_NO DESC)
                            WHERE ROWNUM =1;
            
            
                          SELECT MAX(SEQ_NO)
                          INTO v_seq_no
                         FROM CERTIFICATE_DETAIL
                          WHERE AUDIT_SEQ_NO = v_audit_seq_no;
               
               
                       END IF;
               
             
             END IF;
             
             
             UPDATE CERTIFICATE_DETAIL 
             SET ACTIVE_STATUS=0
             WHERE AUDIT_SEQ_NO =v_audit_seq_no
             AND SEQ_NO = v_seq_no;
             
             
              UPDATE CERTIFICATE_DETAIL
                 SET ACTIVE_STATUS = 1
                WHERE VESSEL_IMO_NO = p_vessel_imo_no
               AND AUDIT_SEQ_NO = p_audit_seq_no 
               AND AUDIT_TYPE_ID = p_audit_type_id
               AND CERTIFICATE_NO = p_certificate_no
               AND SEQ_NO IN (SELECT MAX(SEQ_NO)
               FROM CERTIFICATE_DETAIL
               WHERE VESSEL_IMO_NO = p_vessel_imo_no
                AND AUDIT_TYPE_ID = p_audit_type_id 
                AND AUDIT_SEQ_NO =p_audit_seq_no 
                AND CERTIFICATE_NO = p_certificate_no);
                
      
      
         END IF;
      
      END IF; */
   
   
   commit;
   END;
/
