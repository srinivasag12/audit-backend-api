DROP TRIGGER AUDIT_STAG_TEST.CAR_AUDIT_STATUS_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."CAR_AUDIT_STATUS_TRG"   
   AFTER INSERT
   ON AUDIT_STAG_TEST.AUDIT_FINDINGS_DETAILS    FOR EACH ROW
DECLARE
   v_from                  VARCHAR2 (30) := audit_details_pkg.v_From;
   v_to                    VARCHAR2 (300);
   v_sub                   VARCHAR2 (500);
   v_body                  VARCHAR2 (1000);
   v_cur_audit_seq_no      NUMBER;
   v_orig_seq_no           NUMBER;
   v_company_id            NUMBER;
   v_cc                    VARCHAR2 (30);-- := audit_details_pkg.v_admin;
   v_vsl_name              VARCHAR2 (200);
   v_vsl_imo_no            VARCHAR2 (30);
   v_aud_type              VARCHAR2 (200);
   v_aud_sub_type          VARCHAR2 (200);
   v_ism_code              VARCHAR (100);
   v_ism_ele               VARCHAR2 (1000);
   v_find_categ            VARCHAR2 (30);
   v_due_date              VARCHAR2 (100);
   v_date_ins              DATE;
   v_user_ins              VARCHAR2 (100);
   v_status_seq_no         NUMBER;
   v_finding_seq_no        NUMBER;
   v_finding_category_id   NUMBER;
   audit_desc_msg          VARCHAR2 (20);
   v_audit_type_id         NUMBER;

   v_err_msg               VARCHAR2 (1000);
   v_user                  VARCHAR2 (30);

   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
select user_id into v_cc from ma_user_roles where role_id=1002;
   CASE
      WHEN INSERTING
      THEN
         v_cur_audit_seq_no := :new.cur_audit_seq_no;
         DBMS_OUTPUT.put_line ('step1');

         CASE
            WHEN v_cur_audit_seq_no = 600000
            THEN
               v_company_id := :new.company_id;
               v_status_seq_no := :new.status_seq_no;
               v_orig_seq_no := :new.orig_seq_no;
               v_finding_seq_no := :new.finding_seq_no;
               v_due_date := :new.due_date;
               v_user_ins := :new.user_ins;
               v_date_ins := :new.date_ins;
               v_finding_category_id := :new.finding_category_id;
               v_audit_type_id := :new.audit_type_id;

               DBMS_OUTPUT.put_line ('step2');
               /*create table AuditCarLogTest
               (
               companyId number,
               StatusSeqNo number,
               OrgSeqNo number,
               FindingSeqNo number,
               DueDate date,
               UserIns varchar2(50),
               FindingCategId number,
               AduitTypeId number)
               */

               DBMS_OUTPUT.put_line (
                     ' v_company_id '
                  || v_company_id
                  || ' v_status_seq_no '
                  || v_status_seq_no
                  || ' v_orig_seq_no '
                  || v_orig_seq_no
                  || ' v_finding_seq_no '
                  || v_finding_seq_no
                  || ' v_due_date '
                  || v_due_date
                  || ' v_user_ins '
                  || v_user_ins
                  || ' v_finding_category_id '
                  || v_finding_category_id
                  || ' v_audit_type_id '
                  || v_audit_type_id
                  || ' v_date_ins '
                  || v_date_ins);

               /*
               insert into AuditCarLogTest values(v_company_id, v_status_seq_no, v_orig_seq_no,
               v_finding_seq_no, v_due_date, v_user_ins, v_finding_category_id,
               v_audit_type_id, v_date_ins);
               */

               SELECT AUDIT_TYPE_DESC
                 INTO v_aud_type
                 FROM ma_audit_type
                WHERE audit_type_id = v_audit_type_id
                      AND company_id = v_company_id;

               DBMS_OUTPUT.put_line ('v_aud_type ' || v_aud_type);

               SELECT AUDIT_SUBTYPE_DESC
                 INTO v_aud_sub_type
                 FROM audit_details ad, ma_audit_subtype mast
                WHERE     ad.audit_type_id = mast.audit_type_id
                      AND ad.audit_sub_type_id = mast.audit_sub_type_id
                      AND ad.company_id = mast.company_id
                      AND ad.audit_type_id = v_audit_type_id
                      AND ad.company_id = v_company_id
                      AND ad.audit_seq_no = v_orig_seq_no;

               DBMS_OUTPUT.put_line ('v_aud_sub_type ' || v_aud_sub_type);

               SELECT mv.vessel_imo_no, mv.vessel_name
                 INTO v_vsl_imo_no, v_vsl_name
                 FROM ma_vessel mv
                WHERE (mv.vessel_imo_no, mv.company_id) IN
                         (SELECT ad.vessel_imo_no, ad.company_id
                            FROM audit_Details ad
                           WHERE     ad.audit_type_id = v_audit_type_id
                                 AND ad.company_id = v_company_id
                                 AND ad.audit_seq_no = v_orig_seq_no);

               DBMS_OUTPUT.put_line (
                     'v_vsl_imo_no '
                  || v_vsl_imo_no
                  || 'and  v_vsl_name '
                  || v_vsl_name);

               /*
                              SELECT ad.vessel_imo_no,
                                     mv.vessel_name,
                                     mat.audit_type_desc,
                                     mst.audit_subtype_desc
                                INTO v_vsl_imo_no,
                                     v_vsl_name,
                                     v_aud_type,
                                     v_aud_sub_type
                                FROM AUDIT_FINDINGS_DETAILS afd,
                                     ma_vessel mv,
                                     audit_details ad,
                                     ma_audit_type mat,
                                     ma_audit_subtype mst
                               WHERE     afd.orig_seq_no = ad.audit_seq_no
                                     AND afd.company_id = ad.company_id
                                     AND ad.vessel_imo_no = mv.vessel_imo_no
                                     AND ad.company_id = mv.company_id
                                     AND ad.audit_type_id = mat.audit_type_id
                                     AND ad.company_id = mat.company_id
                                     AND ad.audit_sub_type_id = mst.audit_sub_type_id
                                     AND ad.audit_type_id = mst.audit_type_id
                                     AND ad.company_id = mst.company_id
                                     AND afd.orig_seq_no = v_orig_seq_no
                                     AND afd.company_id = v_company_id
                                     AND afd.finding_seq_no = v_finding_seq_no
                                     AND afd.status_seq_no = v_status_seq_no
                                     AND afd.audit_type_id = v_audit_type_id;
               */

               SELECT audit_code, audit_elements
                 INTO v_ism_code, v_ism_ele
                 FROM ma_audit_codes
                WHERE (audit_code, audit_type_id, company_id) IN
                         (SELECT audit_code, audit_type_id, company_id
                            FROM audit_findings af
                           WHERE     audit_seq_no = v_orig_seq_no
                                 AND company_id = v_company_id
                                 AND finding_seq_no = v_finding_seq_no
                                 AND audit_type_id = v_audit_type_id);

               /*               SELECT ac.audit_code, ac.audit_elements
                                INTO v_ism_code, v_ism_ele
                                FROM AUDIT_FINDINGS_DETAILS afd,
                                     audit_findings af,
                                     ma_audit_codes ac
                               WHERE     afd.finding_seq_no = af.finding_seq_no
                                     AND afd.orig_seq_no = af.audit_seq_no
                                     AND afd.company_id = af.company_id
                                     AND af.audit_code = ac.audit_code
                                     AND af.company_id = ac.company_id
                                     AND af.audit_type_id = ac.audit_type_id
                                     AND afd.orig_seq_no = v_orig_seq_no
                                     AND afd.company_id = v_company_id
                                     AND afd.finding_seq_no = v_finding_seq_no
                                     AND afd.status_seq_no = v_status_seq_no;
               */
               DBMS_OUTPUT.put_line (
                     'v_ism_code '
                  || v_ism_code
                  || ' and v_ism_ele '
                  || v_ism_ele);

               SELECT mfc.finding_category_desc
                 INTO v_find_categ
                 FROM ma_findings_category mfc
                WHERE     mfc.finding_category_id = v_finding_category_id
                      AND mfc.audit_type_id = v_audit_type_id
                      AND mfc.company_id = v_company_id;

               DBMS_OUTPUT.put_line ('v_find_categ ' || v_find_categ);

               IF :new.AUDIT_TYPE_ID IN (1004, 1005)
               THEN
                  audit_desc_msg := 'Review';
               ELSIF :new.AUDIT_TYPE_ID IN (1003)
               THEN
                  audit_desc_msg := 'Inspection';
               ELSE
                  audit_desc_msg := 'Audit';
               END IF;

               SELECT Muliple_Replace_Fun (
                         subject,
                         NEW t_text ('Vessel IMO No.__'),
                         NEW t_text ('Vessel IMO No. ' || v_vsl_imo_no)),
                      Muliple_Replace_Fun (
                         body,
                         NEW t_text ('Vessel Name:___',
                                     'Vessel IMO #:___',
                                     'Audit Type:___',
                                     'Audit Subtype:___',
                                     'ISM Code__',
                                     'ISM Element___',
                                     'Latest category____',
                                     'Due date:___',
                                     'CAR Update Date:_____',
                                     'Auditor who has Updated:___ '),
                         NEW t_text (
                                'Vessel Name: ' || v_vsl_name,
                                ' Vessel IMO #: ' || v_vsl_imo_no,
                                   ' '
                                || audit_desc_msg
                                || '  type: '
                                || v_aud_type,
                                   ' '
                                || audit_desc_msg
                                || '  Subtype: '
                                || v_aud_sub_type,
                                ' ISM Code ' || v_ism_code,
                                ' ISM Element ' || v_ism_ele,
                                ' Latest category ' || v_find_categ,
                                ' Due date: ' || v_due_date,
                                ' CAR Update Date: ' || v_date_ins,
                                ' Auditor who has Updated: ' || v_user_ins))
                 INTO v_sub, v_body
                 FROM (SELECT subject, body
                         FROM audit_email_dtls
                        WHERE email_seq = 10);

               DBMS_OUTPUT.put_line (v_sub || ' , ' || v_body);

               SELECT listagg (user_id) WITHIN GROUP (ORDER BY audit_seq_no)
                 INTO v_to
                 FROM audit_auditor_details
                WHERE     audit_seq_no = v_orig_seq_no
                      AND company_id = v_company_id
                      AND aud_lead_status = 1
                      AND audit_role_id =
                             (SELECT audit_role_id
                                FROM ma_audit_roles
                               WHERE audit_role_desc LIKE 'AUDITOR'
                                     AND company_id = v_company_id);

               DBMS_OUTPUT.put_line (v_to);

               audit_send_mail_prc (
                     'CAR Maintenance for the audit Cur Audit>> '
                  || v_cur_audit_seq_no
                  || ' Origninal Audit>> '
                  || v_orig_seq_no,
                  v_company_id,
                  v_from,
                  v_to,
                  v_cc || ',' || v_user_ins,
                  v_sub,
                  v_body);
            ELSE
               NULL;
         END CASE;
      ELSE
         NULL;
   END CASE;
EXCEPTION
   WHEN OTHERS
   THEN
      v_err_msg := SQLERRM || ' ' || DBMS_UTILITY.format_error_backtrace;
      DBMS_OUTPUT.put_line (
            '  Outer block exception '
         || SQLCODE
         || ' >> '
         || SQLERRM
         || ' ON '
         || DBMS_UTILITY.format_error_backtrace);

      SELECT USER INTO v_user FROM DUAL;

      INSERT INTO audit_email_log_dtls (email_seq,
                                        access_link,
                                        from_mail,
                                        to_mail,
                                        cc_mail,
                                        subject,
                                        MESSAGE,
                                        status,
                                        error_message,
                                        company_id,
                                        user_ins)
           VALUES (
                     audit_email_dtls_seq.NEXTVAL,
                        'CAR Maintenance for the audit Cur Audit>> '
                     || v_cur_audit_seq_no
                     || ' Origninal Audit>> '
                     || v_orig_seq_no,
                     v_from,
                     v_to,
                     v_cc,
                     v_sub,
                     v_body,
                     'Failed',
                     v_err_msg,
                     v_company_id,
                     v_user);

      COMMIT;
END;
/
