DROP TRIGGER AUDIT_STAG_TEST.NEW_AUDIT_CODE_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."NEW_AUDIT_CODE_TRG"   
   AFTER INSERT OR DELETE OR UPDATE
   ON AUDIT_STAG_TEST.MA_AUDIT_CODES    FOR EACH ROW
DECLARE
   v_from         VARCHAR2 (30) := audit_details_pkg.v_From;
   v_to           VARCHAR2 (3000);
   v_sub          VARCHAR2 (500);
   v_body         VARCHAR2 (1000);
   v_company_id   NUMBER;
   v_audit_code   NUMBER;
   v_cc           VARCHAR2 (30);-- := audit_details_pkg.v_admin;
BEGIN
select user_id into v_cc from ma_user_roles where role_id=1002;
   CASE
      WHEN INSERTING
      THEN
         v_company_id := :new.company_id;
         v_audit_code := :new.audit_code;

         SELECT REPLACE (subject,
                         'New Feature',
                            'New Feature '
                         || (SELECT AUDIT_TYPE_DESC
                               FROM MA_AUDIT_TYPE
                              WHERE AUDIT_TYPE_ID = :NEW.AUDIT_TYPE_ID)
                         || ' Code : "'
                         || (SELECT v_audit_code FROM DUAL)
                         || '" added'),
                REPLACE (body,
                         'New Feature____',
                            'New Audit Type '
                         || (SELECT AUDIT_TYPE_DESC
                               FROM MA_AUDIT_TYPE
                              WHERE AUDIT_TYPE_ID = :NEW.AUDIT_TYPE_ID)
                         || ' Code : "'
                         || (SELECT v_audit_code FROM DUAL)
                         || '"')
           INTO v_sub, v_body
           FROM audit_email_dtls
          WHERE email_seq = 12;

         SELECT listagg (user_id, ',') WITHIN GROUP (ORDER BY role_id)
           INTO v_to
           FROM ma_user_roles
          WHERE company_id = 2 AND role_id = 1001;

         --V_SUB := 'New Feature/Audit Subtype added';
         --V_BODY := 'The New Feature audit code has been added to the Audit System.';
         update master_table_update set table_updation=0 where table_name='AuditCodes'; 
         audit_send_mail_prc ('New Audit Code',
                              v_company_id,
                              v_from,
                              v_to,
                              v_cc,
                              v_sub,
                              v_body);
                              
                              
 when updating 
then 
update master_table_update set table_updation=0 where table_name='AuditCodes'; 
when deleting
then
update master_table_update set table_updation=0 where table_name='AuditCodes';                            
      ELSE
         NULL;
   END CASE;
EXCEPTION
   WHEN OTHERS
   THEN
      NULL;
END;
/
