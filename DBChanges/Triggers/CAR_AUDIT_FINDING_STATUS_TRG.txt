DROP TRIGGER AUDIT_STAG_TEST.CAR_AUDIT_FINDING_STATUS_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST.CAR_AUDIT_FINDING_STATUS_TRG
   AFTER INSERT
   ON AUDIT_STAG_TEST.AUDIT_FINDINGS_DETAILS    FOR EACH ROW
DECLARE
   v_admin                  VARCHAR2 (1000);
   v_from                   VARCHAR2 (30) := audit_details_pkg.v_from;
   v_to                     VARCHAR2 (300);
   v_sub                    VARCHAR2 (500);
   v_body                   VARCHAR2 (4000);
   v_subject                VARCHAR2 (500);
   vMgr                     VARCHAR2 (1000);
   v_bdy                    VARCHAR2 (4000);
   vErrMsg                  VARCHAR2 (4000);
   v_cur_audit_seq_no       NUMBER;
   v_orig_seq_no            NUMBER;
   v_company_id             NUMBER;
   v_cc                     VARCHAR2 (4000);  -- := audit_details_pkg.v_admin;
   v_vsl_name               VARCHAR2 (200);
   v_vsl_imo_no             VARCHAR2 (30);
   v_aud_type               VARCHAR2 (200);
   v_aud_sub_type           VARCHAR2 (200);
   v_ism_code               VARCHAR (100);
   v_ism_ele                VARCHAR2 (1000);
   v_find_categ             VARCHAR2 (30);
   v_due_date               VARCHAR2 (100);
   v_date_ins               DATE;
   v_user_ins               VARCHAR2 (100);
   v_status_seq_no          NUMBER;
   v_finding_seq_no         NUMBER;
   v_finding_category_id    NUMBER;
   audit_desc_msg           VARCHAR2 (20);
   v_audit_type_id          NUMBER;
   v_err_msg                VARCHAR2 (1000);
   v_user                   VARCHAR2 (30);
   v_audit_place            VARCHAR2 (4000);
   v_audit_finding_status   NUMBER;
   v_auditor                VARCHAR2 (1000);

   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   v_cur_audit_seq_no := :new.cur_audit_seq_no;

   IF v_cur_audit_seq_no = 600000
   THEN
      v_company_id := :new.company_id;
      v_status_seq_no := :new.status_seq_no;
      v_orig_seq_no := :new.orig_seq_no;
      v_finding_seq_no := :new.finding_seq_no;
      v_due_date := :new.due_date;
      v_user_ins := :new.user_ins;
      v_date_ins := :new.date_ins;
      v_audit_type_id := :new.audit_type_id;
      v_finding_category_id := :new.FINDING_CATEGORY_ID;
      v_audit_place := :new.AUDIT_PLACE;
      v_audit_finding_status := :new.STATUS_ID;

      IF (:new.AUDIT_PLACE IS NOT NULL)
      THEN
         v_audit_place := 'at ' || :new.AUDIT_PLACE;
      END IF;

      DBMS_OUTPUT.put_line ('v_aud_sub_type ' || v_aud_sub_type);

      SELECT mv.vessel_imo_no, mv.vessel_name
        INTO v_vsl_imo_no, v_vsl_name
        FROM ma_vessel mv
       WHERE (mv.vessel_imo_no, mv.company_id) IN
                (SELECT ad.vessel_imo_no, ad.company_id
                   FROM audit_Details ad
                  WHERE     ad.audit_type_id = v_audit_type_id
                        AND ad.company_id = v_company_id
                        AND ad.audit_seq_no = v_orig_seq_no);

      SELECT audit_code, audit_elements
        INTO v_ism_code, v_ism_ele
        FROM ma_audit_codes
       WHERE (audit_code, audit_type_id, company_id) IN
                (SELECT audit_code, audit_type_id, company_id
                   FROM audit_findings af
                  WHERE     audit_seq_no = v_orig_seq_no
                        AND company_id = v_company_id
                        AND finding_seq_no = v_finding_seq_no
                        AND audit_type_id = v_audit_type_id);


      DBMS_OUTPUT.put_line ('v_find_categ ' || v_find_categ);

      IF :new.AUDIT_TYPE_ID IN (1004, 1005)
      THEN
         audit_desc_msg := 'Review';
      ELSIF :new.AUDIT_TYPE_ID IN (1003)
      THEN
         audit_desc_msg := 'Inspection';
      ELSE
         audit_desc_msg := 'Audit';
      END IF;

      SELECT subject, body
        INTO v_sub, v_bdy
        FROM audit_email_dtls
       WHERE email_seq = 56;

      SELECT muliple_replace_fun (
                v_sub,
                NEW t_text ('Audit', 'IMO No.__'),
                NEW t_text (audit_desc_msg || '  ',
                            ' IMO No. ' || v_vsl_imo_no)),
             muliple_replace_fun (
                v_bdy,
                NEW t_text ('(E.g: NC1)',
                            '(Finding Status),',
                            'Code:___',
                            '(Auditor Name)',
                            '(Date)',
                            'at (Place)',
                            '(Audit Type)',
                            '(Audit Subtype)',
                            'IMO No.:____',
                            'Vessel Name:____',
                            'Official No.:____'),
                NEW t_text (audit_finding_type,
                            finding_status,
                            v_ism_code,
                            auditor_name,
                            v_date_ins,
                            v_audit_place,
                            audit_type_desc,
                            audit_subtype_desc,
                            ' IMO No : ' || v_vsl_imo_no,
                            'Vessel Name: ' || v_vsl_name,
                            'Official No:' || official_num))
        INTO v_subject, v_body
        FROM (SELECT (SELECT audit_type_desc
                        FROM ma_audit_type
                       WHERE audit_type_id = v_audit_type_id
                             AND company_id = v_company_id)
                        audit_type_desc,
                     (SELECT AUDIT_SUBTYPE_DESC
                        FROM audit_details a, ma_audit_subtype b
                       WHERE     a.audit_type_id = b.audit_type_id
                             AND a.audit_sub_type_id = b.audit_sub_type_id
                             AND a.company_id = b.company_id
                             AND a.audit_type_id = v_audit_type_id
                             AND a.company_id = v_company_id
                             AND a.audit_seq_no = v_orig_seq_no)
                        audit_subtype_desc,
                     (SELECT FINDING_CATEGORY_DESC
                        FROM MA_FINDINGS_CATEGORY
                       WHERE     company_id = v_company_id
                             AND FINDING_CATEGORY_ID = v_finding_category_id
                             AND AUDIT_TYPE_ID = v_audit_type_id)
                        audit_finding_type,
                     (SELECT First_name || ' ' || Last_Name
                        FROM MA_USERS
                       WHERE company_id = v_company_id
                             AND User_id = v_user_ins)
                        auditor_name,
                     (SELECT OFFICIAL_NO
                        FROM ma_vessel
                       WHERE VESSEL_IMO_NO = v_vsl_imo_no
                             AND company_id = v_company_id)
                        official_num,
                     (SELECT FINDING_STATUS_DESC
                        FROM MA_FINDINGS_STATUS
                       WHERE     FINDING_STATUS_ID = v_audit_finding_status
                             AND AUDIT_TYPE_ID = v_audit_type_id
                             AND COMPANY_ID = v_company_id)
                        finding_status
                FROM DUAL) TEST;

      SELECT user_Id
        INTO v_to
        FROM audit_auditor_details
       WHERE     AUD_LEAD_STATUS = 1
             AND audit_seq_no = v_orig_seq_no
             AND company_id = v_company_id;


      SELECT listagg (a.user_id, ',') WITHIN GROUP (ORDER BY a.audit_seq_no)
        INTO v_auditor
        FROM audit_auditor_details a
       WHERE a.audit_role_id IN
                (SELECT audit_role_id
                   FROM ma_audit_roles
                  WHERE REGEXP_LIKE (audit_role_desc, 'AUDITOR')
                        AND company_id = v_company_id)
             AND A.AUD_LEAD_STATUS <> 1
             AND a.audit_seq_no = v_orig_seq_no
             AND a.company_id = v_company_id;


      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO vMgr
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1003 AND company_id = v_company_id;

      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_admin
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1002 AND company_id = v_company_id;


      IF v_auditor IS NOT NULL
      THEN
         v_cc := v_auditor || ', ' || vMgr || ',' || v_admin;
      ELSE
         v_cc := vMgr || ',' || v_admin;
      END IF;

      DBMS_OUTPUT.put_line (v_bdy);
      audit_send_mail_prc (
         'CAR Maintenance for the audit  ' || v_orig_seq_no,
         v_company_id,
         v_from,
         v_to,
         v_cc,
         v_subject,
         v_body);
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject, body
        INTO v_sub, v_bdy
        FROM audit_email_dtls
       WHERE email_seq = 56;

      DBMS_OUTPUT.put_line (
            '  OUTER BLOCK EXCEPTION '
         || SQLCODE
         || ' >> '
         || SQLERRM
         || '  >> '
         || DBMS_UTILITY.format_error_backtrace);
      vErrMsg := SQLERRM || ' on ' || DBMS_UTILITY.format_error_backtrace;
      audit_send_mail_prc (
         p_audit_no     => 'CAR Maintenance for the audit ' || v_orig_seq_no,
         p_company_id   => v_company_id,
         p_from_mail    => v_from,
         p_to_mail      => audit_details_pkg.V_BSOLTEAM,
         p_subject      => v_sub,
         p_body         => vErrMsg);
END;
/
