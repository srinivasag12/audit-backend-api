DROP TRIGGER AUDIT_STAG_TEST.AUD_CHEC_VOID;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."AUD_CHEC_VOID"   
after update of audit_status_id 
on audit_details
for each row
DISABLE
declare
audit_desc_msg  VARCHAR2 (20);
V_SUB varchar2(200);
V_BDY varchar2(300);
V_TO VARCHAR2(1000);
V_FROM VARCHAR2(100):= audit_details_pkg.v_From;
V_CC VARCHAR2(100);
v_audit_no               NUMBER;
v_company_id             NUMBER;
v_flag                   NUMBER;
v_vessel_imo_no          VARCHAR2 (100);
v_audit_sub_typeid       NUMBER;
v_audit_type_id          NUMBER;
v_certificate_issue_id   NUMBER;
begin

IF :new.audit_status_id = 1004
         AND :new.audit_status_id <> :old.audit_status_id
   THEN
      v_audit_no := :old.audit_seq_no;
      v_company_id := :old.company_id;
      v_flag := 7;
      v_vessel_imo_no := :old.vessel_imo_no;
      v_audit_sub_typeid := :old.audit_sub_type_id;
      v_audit_type_id := :old.audit_type_id;
      v_certificate_issue_id := :old.certificate_issue_id;

      SELECT subject, body
        INTO v_sub, v_bdy
        FROM audit_email_dtls
       WHERE email_seq = 8;

      IF v_audit_type_id IN (1004, 1005)
      THEN
         audit_desc_msg := 'Review';
      ELSIF v_audit_type_id IN (1003)
      THEN
         audit_desc_msg := 'Inspection';
      ELSE
         audit_desc_msg := 'Audit';
      END IF;

      SELECT muliple_replace_fun (
                v_sub,
                NEW t_text ('Audit Type:__',
                            'Vessel IMO No.:__',
                            'Certificate#:__',
                            'Audit is'),
                NEW t_text (audit_desc_msg || ' Type: ' || audit_type_desc,
                            'Vessel IMO No.:' || v_vessel_imo_no,
                            'Certificate#:' || certificate_issue_desc,
                            audit_desc_msg || ' is ')),
             muliple_replace_fun (
                v_bdy,
                NEW t_text ('Audit type__',
                            'Vessel IMO No__',
                            'Audit Subtype__'),
                NEW t_text (
                       audit_desc_msg || ' type ' || audit_type_desc,
                       'Vessel IMO No ' || v_vessel_imo_no,
                       audit_desc_msg || ' Subtype ' || audit_subtype_desc))
        INTO v_sub, v_bdy
        FROM (SELECT (SELECT certificate_issue_desc
                        FROM ma_certificate_issued
                       WHERE certificate_issue_id = v_certificate_issue_id
                             AND audit_type_id = v_audit_type_id
                             AND company_id = v_company_id)
                        certificate_issue_desc,
                     (SELECT audit_type_desc
                        FROM ma_audit_type
                       WHERE audit_type_id = v_audit_type_id
                             AND company_id = v_company_id)
                        audit_type_desc,
                     (SELECT audit_subtype_desc
                        FROM ma_audit_subtype
                       WHERE     audit_sub_type_id = v_audit_sub_typeid
                             AND audit_type_id = v_audit_type_id
                             AND company_id = v_company_id)
                        audit_subtype_desc
                FROM DUAL) test;

      SELECT listagg (a.user_id, ',') WITHIN GROUP (ORDER BY a.audit_seq_no)
        INTO v_to
        FROM audit_auditor_details a
       WHERE a.audit_role_id IN
                (SELECT audit_role_id
                   FROM ma_audit_roles
                  WHERE REGEXP_LIKE (audit_role_desc, 'AUDITOR')
                        AND company_id = v_company_id)
             AND A.AUD_LEAD_STATUS = 1
             AND a.audit_seq_no = v_audit_no
             AND a.audit_seq_no = v_audit_no
             AND a.company_id = v_company_id;

select user_id into v_cc from ma_user_roles where role_id=1002;
                 --v_cc := audit_details_pkg.v_admin;
                    dbms_output.put_line(v_audit_no);
                     dbms_output.put_line(      v_company_id);
                           dbms_output.put_line(v_from);
                     dbms_output.put_line(      v_to);
                           dbms_output.put_line(v_cc);
                           dbms_output.put_line(v_sub);
                           dbms_output.put_line(v_bdy);
      audit_send_mail_prc ('Void status ' || v_audit_no,
                           v_company_id,
                           v_from,
                           v_to,
                           v_cc,
                           v_sub,
                           v_bdy);

   end if;
   end;
/
