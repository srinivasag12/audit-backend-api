DROP TRIGGER AUDIT_STAG_TEST.REVERTING_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."REVERTING_TRG"
   AFTER UPDATE OF review_status
   ON audit_details
   FOR EACH ROW
DECLARE
   v_err_msg             VARCHAR2 (1000);
   v_subject             VARCHAR2 (1000 BYTE);
   v_body                VARCHAR2 (500 BYTE);
   v_sub                 VARCHAR2 (500 BYTE);
   v_bdy                 VARCHAR2 (500 BYTE);
   v_audit_type_id       NUMBER;
   v_cc                  VARCHAR2 (1000 BYTE);
   v_test            VARCHAR2 (1000 BYTE);
   v_to                  VARCHAR2 (500 BYTE);
   vLeadAud              VARCHAR2 (200 BYTE);
   vLeadName             VARCHAR2 (200 BYTE);
   audit_desc_msg        VARCHAR2 (100 BYTE);
   v_company_id          NUMBER;
   v_from                VARCHAR2 (200 BYTE) := AUDIT_DETAILS_PKG.v_from;
   v_audit_no            NUMBER;
   v_admin               VARCHAR2 (200 BYTE);
   v_vessel_imo_no       VARCHAR2 (100);
   v_audit_sub_type_id   NUMBER;
   vMgr                  VARCHAR2 (200);
   v_mgr                 VARCHAR2 (4000);
   v_vessel_name         VARCHAR2 (200 BYTE);
   v_official_no         NUMBER;
   v_identify_mail       VARCHAR2 (50);
BEGIN
   IF UPDATING ('review_status')
   THEN
      v_audit_no := :new.audit_seq_no;
      v_company_id := :new.company_id;
      v_vessel_imo_no := :new.vessel_imo_no;
      v_audit_sub_type_id := :new.audit_sub_type_id;
      v_audit_type_id := :new.audit_type_id;

      IF v_audit_type_id IN (1004, 1005)
      THEN
         audit_desc_msg := 'Review';
      ELSIF v_audit_type_id IN (1003)
      THEN
         audit_desc_msg := 'Inspection';
      ELSIF v_audit_type_id IN (1001, 1002)
      THEN
         audit_desc_msg := 'Audit';
      ELSE
         audit_desc_msg := NULL;
      END IF;

      IF :new.review_status <> :old.review_status AND :new.review_status = 0
      THEN
         SELECT user_id
           INTO v_to
           FROM audit_auditor_details
          WHERE     audit_seq_no = v_audit_no
                AND company_id = v_company_id
                AND audit_role_id = 1003
                AND aud_lead_status = 0;

         SELECT user_id, first_name || ' ' || Last_name
           INTO vLeadAud, vLeadName
           FROM MA_USERS
          WHERE (user_id, company_id) =
                   (SELECT user_id, company_id
                      FROM audit_auditor_details
                     WHERE     audit_seq_no = :old.audit_seq_no
                           AND company_id = :old.company_id
                           AND audit_role_id = 1001
                           AND aud_lead_status = 1);

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_admin
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1002 AND company_id = v_company_id;

         v_cc := vLeadAud || ',' || v_admin;

         SELECT subject, body
          INTO v_sub, v_bdy
           FROM AUDIT_EMAIL_DTLS
          WHERE email_seq = 23;

         SELECT muliple_replace_fun (
                   v_sub,
                   NEW t_text ('Audit (Type:__ , Subtype:__)',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___'),
                   NEW t_text (
                             audit_desc_msg
                          || '(Type: '
                          || audit_type_desc
                          || ', Sub Type: '
                          || audit_subtype_desc
                          || ')',
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || v_vessel_imo_no,
                          '& Official No: ' || v_official_no)),
                muliple_replace_fun (
                   v_bdy,
                   NEW t_text ('Audit type__',
                               'Audit Subtype__',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___',
                               'Lead Auditor/Inspector:__'),
                   NEW t_text (
                          audit_desc_msg || ' type: ' || audit_type_desc,
                             audit_desc_msg
                          || ' Subtype: '
                          || audit_subtype_desc,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || v_vessel_imo_no,
                          '& Official No: ' || v_official_no,
                          'by ' || vLeadName))
           INTO v_sub, v_bdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_type_id
                                AND audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_subtype_desc,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_official_no,
                        (SELECT (FIRST_NAME || ' ' || LAST_NAME)
                           FROM MA_USERS
                          WHERE USER_ID =
                                   (SELECT user_id
                                      FROM audit_auditor_details
                                     WHERE     audit_seq_no = v_audit_no
                                           AND AUD_LEAD_STATUS = 1
                                           AND company_id = v_company_id))
                           vLeadName
                   FROM DUAL) test;

         v_identify_mail :=
            'Revert review for ' || audit_desc_msg || ': ' || v_audit_no;
      END IF;

      IF :new.review_status <> :old.review_status AND :new.review_status = 1
      THEN
         SELECT subject, body
           INTO v_sub, v_bdy
           FROM audit_email_dtls
          WHERE email_seq = 81;

         SELECT muliple_replace_fun (
                   v_sub,
                   NEW t_text ('Audit Type:__',
                               'Vessel:__',
                               'IMO No.:__',
                               'Official No.:___'),
                   NEW t_text (audit_desc_msg || 'Type: ' || audit_type_desc,
                               'Vessel: ' || v_vessel_name,
                               'IMO No: ' || v_vessel_imo_no,
                               'Official No: ' || v_official_no)),
                muliple_replace_fun (
                   v_bdy,
                    NEW t_text ('Audit type__',
                               'Audit Subtype__',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___',
                               'Lead Auditor/Inspector:__'),
                    NEW t_text (
                       audit_desc_msg || ' type: ' || audit_type_desc,
                             audit_desc_msg
                          || ' Subtype: '
                          || audit_subtype_desc,
                        'Vessel: ' || v_vessel_name,
                        'IMO No: ' || v_vessel_imo_no,
                         '& Official No: ' || v_official_no,
                        'Lead Auditor/Inspector: ' || vLeadName))
           INTO v_sub, v_bdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_type_id
                                AND audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_subtype_desc,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_official_no,
                        (SELECT first_name || ' ' || last_name
                           FROM audit_auditor_details aad, ma_users mu
                          WHERE     aad.user_id = mu.user_id
                                AND aad.company_id = mu.company_id
                                AND aad.aud_lead_status = 1
                                AND aad.audit_role_id =
                                       (SELECT audit_role_id
                                          FROM ma_audit_roles
                                         WHERE audit_role_desc LIKE 'AUDITOR'
                                               AND company_id = v_company_id)
                                AND aad.audit_seq_no = v_audit_no
                                AND aad.company_id = v_company_id)
                           vLeadName
                   FROM DUAL) test;

         SELECT listagg (a.user_id, ',')
                   WITHIN GROUP (ORDER BY a.audit_seq_no)
           INTO v_to
           FROM audit_auditor_details a
          WHERE a.audit_role_id IN
                   (SELECT audit_role_id
                      FROM ma_audit_roles
                     WHERE audit_role_desc LIKE 'REVIEWER'
                           AND company_id = v_company_id)
                AND a.audit_seq_no = v_audit_no
                AND a.company_id = v_company_id;

         SELECT listagg (a.user_id, ',')
                   WITHIN GROUP (ORDER BY a.audit_seq_no)
           INTO v_cc
           FROM audit_auditor_details a
          WHERE a.aud_lead_status = 1
                AND a.audit_role_id IN
                       (SELECT audit_role_id
                          FROM ma_audit_roles
                         WHERE audit_role_desc LIKE 'AUDITOR'
                               AND company_id = v_company_id)        --, 1003)
                AND a.audit_seq_no = v_audit_no
                AND a.company_id = v_company_id;

         v_cc := v_cc || ',' || audit_details_pkg.v_admin || ',' || AUDIT_DETAILS_PKG.V_REVIEW;

         v_identify_mail := 'Initiated Review ' || v_audit_no;
      END IF;


      IF :new.review_status <> :old.review_status AND :new.review_status = 3
      THEN
         SELECT subject, body
          INTO v_sub, v_bdy
           FROM audit_email_dtls
          WHERE email_seq = 49;

         SELECT muliple_replace_fun (
                   v_sub,
                   NEW t_text ('(Audit Type)',
                               '(Audit Subtype)',
                               'Audit/ Inspection/ Review',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___'),
                   NEW t_text (audit_type_desc,
                               audit_subtype_desc,
                               audit_desc_msg,
                               'Vessel: ' || v_vessel_name,
                               'IMO No: ' || v_vessel_imo_no,
                               '& Official No: ' || v_official_no)),
                muliple_replace_fun (
                   v_bdy,
                   NEW t_text ('(Audit Type)',
                               '(Audit Subtype)',
                               'Audit/ Inspection/ Review',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___',
                               'Reason:__'),
                   NEW t_text (audit_type_desc,
                               audit_subtype_desc,
                               audit_desc_msg,
                               'Vessel: ' || v_vessel_name,
                               'IMO No: ' || v_vessel_imo_no,
                               '& Official No: ' || v_official_no,
                               'Reason: ' || :NEW.REJECTION_REASON))
           INTO v_sub, v_bdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_type_id
                                AND audit_type_id = v_audit_type_id
                                AND company_id = v_company_id)
                           audit_subtype_desc,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_official_no
                   FROM DUAL) test;

         SELECT listagg (a.user_id, ',')
                   WITHIN GROUP (ORDER BY a.audit_seq_no)
           INTO v_cc
           FROM audit_auditor_details a
          WHERE     a.audit_seq_no = v_audit_no
                AND a.company_id = v_company_id
                AND A.AUD_LEAD_STATUS <> 1;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_admin
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1002 AND company_id = v_company_id;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_mgr
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1003 AND company_id = v_company_id;

         v_cc := v_cc || ',' || v_admin || ',' || v_mgr;

         SELECT listagg (a.user_id, ',')
                   WITHIN GROUP (ORDER BY a.audit_seq_no)
           INTO v_to
           FROM audit_auditor_details a
          WHERE a.aud_lead_status = 1
                AND a.audit_role_id IN
                       (SELECT audit_role_id
                          FROM ma_audit_roles
                         WHERE audit_role_desc LIKE 'AUDITOR'
                               AND company_id = v_company_id)
                AND a.audit_seq_no = v_audit_no
                AND a.company_id = v_company_id;

         v_identify_mail := 'Reviewer Rejected the audit ' || v_audit_no;
      END IF;

      IF (v_identify_mail IS NOT NULL)
      THEN
         audit_send_mail_prc (v_identify_mail,
                              v_company_id,
                              v_from,
                              v_to,
                              v_cc,
                              v_sub,
                              v_bdy);
      END IF;
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject
        INTO v_sub
        FROM AUDIT_EMAIL_DTLS
       WHERE email_seq = 23;

      DBMS_OUTPUT.put_line (
            '  OUTER BLOCK EXCEPTION '
         || SQLCODE
         || ' >> '
         || SQLERRM
         || '  >> '
         || DBMS_UTILITY.format_error_backtrace);
      v_err_msg := SQLERRM || ' on ' || DBMS_UTILITY.format_error_backtrace;
      audit_send_mail_prc (
         p_audit_no     => 'Revert review for Audit ' || v_audit_no,
         p_company_id   => v_company_id,
         p_from_mail    => v_from,
         p_to_mail      => audit_details_pkg.V_BSOLTEAM,
         p_subject      => v_sub,
         p_body         => v_err_msg);
END;
/
