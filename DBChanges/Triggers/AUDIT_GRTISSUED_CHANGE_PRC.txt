DROP TRIGGER AUDIT_STAG_TEST.AUDIT_GRTISSUED_CHANGE_PRC;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."AUDIT_GRTISSUED_CHANGE_PRC"   
after update of grt--CERT_ISSUED_DATE
on ma_vessel--,audit_details
for each row
DISABLE
declare
audit_status_id number;
vessel_imo_no varchar2(200 byte);
audit_type_id number;
vleadaudit varchar2(200 byte);
subject varchar2(200 byte);
body varchar2(200 byte);
 v_to varchar2(200 byte);--:=audit_details_pkg.v_admin;
 v_from varchar2(200 byte);
 v_sub varchar2(200 byte);
 v_body varchar2(200 byte);
 v_cc varchar2(200 byte);
 begin 
 select user_id into v_to from ma_user_roles where role_id=1002;
 if updating('grt') then
 if audit_status_id=1002 then
  select muliple_replace_fun(subject,
  new t_text('RMI admin'),new t_text(v_to)),
  muliple_replace_fun(body,
 new t_text('Old_Value____','to the New Value_____',
 'by the Admin____','Vessel IMO No____','Audit Subtype____,',
 'Audit type:____'),
  new t_text('Old_Value'||:old.grt,'to the New Value'||:new.grt,'by the Admin'||vleadaudit,'Vessel IMO No'||vessel_imo_no,
  'Audit Subtype||audit_subtype_id','Audit type:'||audit_type_id))
  into v_sub,v_body from(select subject,body from audit_email_dtls where email_seq=36);
  ---------

SELECT listagg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_cc
     FROM ma_user_roles
    WHERE role_id in(SELECT role_id
                       FROM ma_roles
                      WHERE role_desc IN('Auditor','Manager'));
  dbms_output.put_line(v_cc);
end if ;
end if;
  end;
/
