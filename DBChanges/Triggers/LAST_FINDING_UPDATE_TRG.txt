DROP TRIGGER AUDIT_STAG_TEST.LAST_FINDING_UPDATE_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."LAST_FINDING_UPDATE_TRG"
   AFTER INSERT
   ON AUDIT_STAG_TEST.AUDIT_FINDINGS_DETAILS    FOR EACH ROW
DECLARE
   v_err_msg               VARCHAR2 (200);
   v_body1                 VARCHAR2 (4000);
   v_prevLaudit            VARCHAR2 (200);
   v_cur_audit             VARCHAR2 (200);
   v_manager               VARCHAR2 (500);
   v_aud_sub_type          VARCHAR2 (200);
   v_aud_type              VARCHAR2 (200);
   v_from                  VARCHAR2 (200) := audit_details_pkg.v_From;
   v_to                    VARCHAR2 (200);
   v_cc                    VARCHAR2 (1000);
   v_audit_type            NUMBER;
   v_audit_sub_type        NUMBER;
   v_vessel_imo_no         VARCHAR2 (200);
   v_status_seq_no         NUMBER;
   v_cur_audit_seq_no      NUMBER;
   v_orig_seq_no           NUMBER;
   v_finding_seq_no        NUMBER;
   v_finding_category_id   NUMBER;
   v_status_id             NUMBER;
   v_status_date           DATE;
   v_next_action_id        NUMBER;
   v_due_date              VARCHAR2 (200);
   v_description           VARCHAR2 (2000);
   v_company_id            NUMBER;
   v_user_ins              VARCHAR2 (200);
   v_date_ins              DATE;
   v_audit_type_id         NUMBER;
   v_admin                 VARCHAR2 (200);
   v_subject               VARCHAR2 (200);
   v_body                  VARCHAR2 (2000);
   v_vessel_name           VARCHAR2 (200);
   v_official_no           NUMBER;

   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   v_cur_audit_seq_no := :new.cur_audit_seq_no;
   v_orig_seq_no := :new.orig_seq_no;

   IF (v_orig_seq_no <> v_cur_audit_seq_no AND v_cur_audit_seq_no <> 600000)
   THEN
      v_status_seq_no := :new.status_seq_no;
      v_finding_seq_no := :new.finding_seq_no;
      v_finding_category_id := :new.finding_category_id;
      v_status_id := :new.status_id;
      v_status_date := :new.status_date;
      v_next_action_id := :new.next_action_id;
      v_due_date := :new.due_date;
      v_description := :new.description;
      v_company_id := :new.company_id;
      v_user_ins := :new.user_ins;
      v_date_ins := :new.date_ins;
      v_audit_type_id := :new.audit_type_id;

      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_admin
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1002 AND company_id = v_company_id;

      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_manager
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1003 AND company_id = v_company_id;

      SELECT vessel_imo_no, audit_sub_type_id
        INTO v_vessel_imo_no, v_audit_sub_type
        FROM audit_details
       WHERE     audit_seq_no = v_cur_audit_seq_no
             AND company_id = v_company_id
             AND audit_type_id = v_audit_type_id;

      SELECT AUDIT_TYPE_DESC
        INTO v_aud_type
        FROM ma_audit_type
       WHERE audit_type_id = v_audit_type_id AND company_id = v_company_id;

      SELECT AUDIT_SUBTYPE_DESC
        INTO v_aud_sub_type
        FROM audit_details ad, ma_audit_subtype mast
       WHERE     ad.audit_type_id = mast.audit_type_id
             AND ad.audit_sub_type_id = mast.audit_sub_type_id
             AND ad.company_id = mast.company_id
             AND ad.audit_type_id = v_audit_type_id
             AND ad.company_id = v_company_id
             AND ad.audit_seq_no = v_orig_seq_no;

      --to pick prevoius auditor
      SELECT user_ins
        INTO v_prevLaudit
        FROM audit_auditor_details
       WHERE     audit_seq_no = v_cur_audit_seq_no
             AND company_id = v_company_id
             AND audit_type_id = v_audit_type_id
             AND audit_role_id = 1001
             AND aud_lead_status = 1;

      -- to pick current auditor
      SELECT NVL (
                (SELECT user_ins
                   FROM audit_auditor_details
                  WHERE     audit_seq_no = v_orig_seq_no
                        AND company_id = v_company_id
                        AND audit_type_id = v_audit_type_id
                        AND audit_role_id = 1001
                        AND aud_lead_status = 1),
                '')
        INTO v_cur_audit
        FROM DUAL;

      SELECT subject
        INTO v_subject
        FROM audit_email_dtls
       WHERE email_seq = 43;

      SELECT VESSEL_NAME
        INTO v_vessel_name
        FROM MA_VESSEL
       WHERE VESSEL_IMO_NO = v_vessel_imo_no AND COMPANY_ID = v_company_id;

      SELECT OFFICIAL_NO
        INTO v_official_no
        FROM MA_VESSEL
       WHERE VESSEL_IMO_NO = v_vessel_imo_no AND COMPANY_ID = v_company_id;

      SELECT muliple_replace_fun (
                body,
                NEW t_text ('Audit Subtype:__',
                            'Audit Type:__',
                            'Vessel:___',
                            'IMO No.:__',
                            'Official No.:___'),
                NEW t_text ('Audit Subtype:' || v_aud_sub_type,
                            'Audit Type:' || v_aud_type,
                            'Vessel: ' || v_vessel_name,
                            'IMO No.' || v_vessel_imo_no,
                            'Official No: ' || v_official_no))
        INTO v_body1
        FROM (SELECT body
                FROM audit_email_dtls
               WHERE email_seq = 43);

      v_cc := v_cur_audit || ',' || v_manager || ',' || v_admin;

      audit_send_mail_prc ('previous finding updated ' || v_cur_audit_seq_no,
                           v_company_id,
                           v_from,
                           v_prevLaudit,
                           v_cc,
                           v_subject,
                           v_body1);
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject
        INTO v_subject
        FROM audit_email_dtls
       WHERE email_seq = 43;

      v_err_msg := SQLERRM || ' on ' || DBMS_UTILITY.format_error_backtrace;
      audit_send_mail_prc (
         p_audit_no     =>   'previous finding updated'
                          || 'orginal audit_seq_no '
                          || v_orig_seq_no
                          || 'current audit_seq_no '
                          || v_cur_audit_seq_no,
         p_company_id   => v_company_id,
         p_from_mail    => v_from,
         p_to_mail      => audit_details_pkg.V_BSOLTEAM,
         p_subject      => v_subject,
         p_body         => v_err_msg);
END;
/
