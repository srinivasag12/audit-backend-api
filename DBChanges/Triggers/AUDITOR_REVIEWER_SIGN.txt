DROP TRIGGER AUDIT_STAG_TEST.AUDITOR_REVIEWER_SIGN;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."AUDITOR_REVIEWER_SIGN"
   AFTER UPDATE
   ON AUDIT_STAG_TEST.AUDIT_AUDITOR_DETAILS    FOR EACH ROW
DECLARE
   vErrMsg                      VARCHAR2 (200);
   v_audit_sub_typeid           NUMBER;
   audit_desc_msg               VARCHAR2 (200);
   v_audit_seq_no               NUMBER;
   v_vessel_imo_no              VARCHAR2 (200);
   v_audit_type                 NUMBER;
   v_audit_subtype              NUMBER;
   v_subject                    VARCHAR2 (2000);
   v_body                       VARCHAR2 (2000);
   v_cc                         VARCHAR2 (1000);
   v_from                       VARCHAR2 (200) := AUDIT_DETAILS_PKG.v_from;
   v_admin                      VARCHAR2 (200);
   vleadaud                     VARCHAR2 (200);
   v_company_id                 NUMBER;
   v_count                      NUMBER;
   v_reviewer                   VARCHAR2 (200);
   v_manager                    VARCHAR2 (1000);
   v_old_aud_signature          BLOB;
   v_new_aud_signature          BLOB;
   v_aud_lead_status            NUMBER;
   v_lead_name                  VARCHAR2 (100);
   v_auditor_name               VARCHAR2 (100);
   v_auditor_id                 VARCHAR2 (100);
   v_auditors                   VARCHAR2 (500);
   v_vessel_name                VARCHAR2 (200);
   v_audit_role_id              NUMBER;
   v_audit_status_id            NUMBER;
   v_additional_auditor_count   NUMBER;
   v_user_id                    VARCHAR2 (50);

   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   IF UPDATING
   THEN
      v_audit_type := :old.audit_type_id;
      v_company_id := :new.company_id;
      v_audit_seq_no := :new.audit_seq_no;
      v_old_aud_signature := :old.aud_signature;
      v_new_aud_signature := :new.aud_signature;
      v_aud_lead_status := :new.aud_lead_status;
      v_auditor_id := :new.USER_ID;
      v_audit_role_id := :NEW.AUDIT_ROLE_ID;
      v_user_id := :NEW.USER_ID;

      IF :old.AUDIT_TYPE_ID IN (1004, 1005)
      THEN
         audit_desc_msg := 'Review';
      ELSIF :old.AUDIT_TYPE_ID IN (1003)
      THEN
         audit_desc_msg := 'Inspection';
      ELSE
         audit_desc_msg := 'Audit';
      END IF;

      SELECT vessel_imo_no, audit_sub_type_id, audit_status_id
        INTO v_vessel_imo_no, v_audit_sub_typeid, v_audit_status_id
        FROM audit_details
       WHERE     audit_seq_no = v_audit_seq_no
             AND company_id = v_company_id
             AND audit_type_id = v_audit_type;

      SELECT user_id
        INTO vleadaud
        FROM audit_auditor_details
       WHERE     audit_seq_no = v_audit_seq_no
             AND audit_role_id = 1001
             AND company_id = v_company_id
             AND aud_lead_status = 1;

      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_manager
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1003 AND company_id = v_company_id;

      SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
        INTO v_admin
        FROM MA_USER_ROLES USRL
       WHERE USRL.ROLE_ID = 1002 AND company_id = v_company_id;

      SELECT listagg (aud.user_id, ',')
                WITHIN GROUP (ORDER BY aud.audit_seq_no)
        INTO v_auditors
        FROM audit_auditor_details aud
       WHERE aud.audit_role_id IN
                (SELECT audit_role_id
                   FROM ma_audit_roles
                  WHERE REGEXP_LIKE (audit_role_desc, 'AUDITOR')
                        AND company_id = v_company_id)
             AND aud.audit_seq_no = v_audit_seq_no
             AND AUD.AUDIT_TYPE_ID = v_audit_type
             AND AUD.AUD_LEAD_STATUS <> 1
             AND aud.company_id = v_company_id;

      SELECT NVL (
                (SELECT user_id
                   FROM audit_auditor_details
                  WHERE     audit_seq_no = v_audit_seq_no
                        AND company_id = v_company_id
                        AND aud_lead_status = 0
                        AND audit_role_id = 1003),
                '')
        INTO v_reviewer
        FROM DUAL;

      IF :new.aud_signature IS NULL
      THEN
         --to pick leadaudit(v_to)
         IF v_old_aud_signature IS NOT NULL
         THEN
            IF :old.audit_role_id = 1003 AND :old.aud_lead_status = 0
            THEN
               SELECT subject, body
                 INTO v_subject, v_body
                 FROM audit_email_dtls
                WHERE email_seq = 35;

               SELECT muliple_replace_fun (
                         v_subject,
                         NEW t_text ('Audit ___  with', 'IMO No.___'),
                         NEW t_text (
                                   audit_desc_msg
                                || '  '
                                || audit_type_desc
                                || ' with',
                                ' IMO No. ' || v_vessel_imo_no)),
                      muliple_replace_fun (
                         v_body,
                         NEW t_text ('Audit Subtype:__,',
                                     'Audit Type:__,',
                                     'Vessel IMO No.:__'),
                         NEW t_text (
                                   audit_desc_msg
                                || ' Subtype: '
                                || audit_subtype_desc,
                                   audit_desc_msg
                                || ' Type: '
                                || audit_type_desc,
                                'Vessel IMO No. ' || v_vessel_imo_no))
                 INTO v_subject, v_body
                 FROM (SELECT (SELECT audit_type_desc
                                 FROM ma_audit_type
                                WHERE audit_type_id = v_audit_type
                                      AND company_id = v_company_id)
                                 audit_type_desc,
                              (SELECT audit_subtype_desc
                                 FROM ma_audit_subtype
                                WHERE audit_sub_type_id = v_audit_sub_typeid
                                      AND audit_type_id = v_audit_type
                                      AND company_id = v_company_id)
                                 audit_subtype_desc
                         FROM DUAL) test;

               v_cc := v_reviewer || ',' || v_admin || ',' || v_manager;

               IF v_new_aud_signature IS NULL
               THEN
                  audit_send_mail_prc (
                     'reviewer removed his sign for' || v_audit_seq_no,
                     v_company_id,
                     v_from,
                     vLeadAud,
                     v_cc,
                     v_subject,
                     v_body);
               END IF;
            END IF;
         END IF;
      END IF;


      IF UPDATING ('DELEGATE_SIGN')
      THEN
         IF (    :NEW.DELEGATE_SIGN IS NOT NULL
             AND :OLD.DELEGATE_SIGN = 1
             AND :NEW.DELEGATE_SIGN = 0)
         THEN
            SELECT subject, body
           INTO v_subject, v_body
              FROM audit_email_dtls
             WHERE email_seq = 68;

            SELECT muliple_replace_fun (
                      v_subject,
                      NEW t_text ('Audit type: ___',
                                  'Subtype:___',
                                  'IMO No.:___',
                                  'Official No.:___'),
                      NEW t_text (
                             audit_desc_msg || ' Type: ' || audit_type_desc,
                                audit_desc_msg
                             || ' Subtype: '
                             || audit_subtype_desc,
                             'IMO No: ' || v_vessel_imo_no,
                             'Official No: ' || v_official_no)),
                   muliple_replace_fun (
                      v_body,
                      NEW t_text ('(Additional Auditor Name)',
                                  'Auditor/ Inspector:___',
                                  'Audit Type:____',
                                  'Audit Subtype:___',
                                  'vessel:___',
                                  'IMO No.:___',
                                  'Official No.:____'),
                      NEW t_text (
                             v_auditor_name,
                             (SELECT CASE
                                        WHEN :new.AUDIT_TYPE_ID IN
                                                (1003, 1005)
                                        THEN
                                           'Inspector'
                                        ELSE
                                           'Auditor'
                                     END
                                FROM DUAL)
                             || ' '
                             || v_lead_name,
                             audit_desc_msg || ' Type: ' || audit_type_desc,
                                audit_desc_msg
                             || ' Subtype: '
                             || audit_subtype_desc,
                             'Vessel: ' || v_vessel_name,
                             'IMO No: ' || v_vessel_imo_no,
                             ' No: ' || v_official_no))
              INTO v_subject, v_body
              FROM (SELECT (SELECT audit_type_desc
                              FROM ma_audit_type
                             WHERE audit_type_id = v_audit_type
                                   AND company_id = v_company_id)
                              audit_type_desc,
                           (SELECT audit_subtype_desc
                              FROM ma_audit_subtype
                             WHERE     audit_sub_type_id = v_audit_sub_typeid
                                   AND audit_type_id = v_audit_type
                                   AND company_id = v_company_id)
                              audit_subtype_desc,
                           (SELECT OFFICIAL_NO
                              FROM MA_VESSEL
                             WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                   AND COMPANY_ID = v_company_id)
                              v_official_no,
                           (SELECT VESSEL_NAME
                              FROM MA_VESSEL
                             WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                   AND COMPANY_ID = v_company_id)
                              v_vessel_name,
                           (SELECT first_name || ' ' || last_name
                              FROM ma_users
                             WHERE user_id = v_auditor_id
                                   AND company_id = v_company_id)
                              v_auditor_name,
                           (SELECT first_name || ' ' || last_name
                              FROM audit_auditor_details aad, ma_users mu
                             WHERE     aad.user_id = mu.user_id
                                   AND aad.company_id = mu.company_id
                                   AND aad.aud_lead_status = 1
                                   AND aad.audit_role_id IN
                                          (SELECT audit_role_id
                                             FROM ma_audit_roles
                                            WHERE REGEXP_LIKE (
                                                     audit_role_desc,
                                                     'AUDITOR')
                                                  AND company_id =
                                                         v_company_id)
                                   AND aad.audit_seq_no = v_audit_seq_no
                                   AND aad.company_id = v_company_id)
                              v_lead_name
                      FROM DUAL) test;

            v_cc := v_auditors || ',' || v_admin || ',' || v_manager;

            audit_send_mail_prc (
               'pulling/ reverting back the delegate signature '
               || v_audit_seq_no,
               v_company_id,
               v_from,
               vLeadAud,
               v_cc,
               v_subject,
               v_body);
         END IF;
    
   
     IF (    :NEW.DELEGATE_SIGN IS NOT NULL
             AND :OLD.DELEGATE_SIGN = 0
             AND :NEW.DELEGATE_SIGN = 1)
         THEN
         
         SELECT subject, body
           INTO v_subject, v_body
           FROM audit_email_dtls
          WHERE email_seq = 67;

         SELECT muliple_replace_fun (
                   v_subject,
                   NEW t_text ('Audit type: ___',
                               'Subtype:___',
                               'IMO No.:___',
                               'Official No.:___'),
                   NEW t_text (
                          audit_desc_msg || ' Type: ' || audit_type_desc,
                             audit_desc_msg
                          || ' Subtype: '
                          || audit_subtype_desc,
                          'IMO No: ' || v_vessel_imo_no,
                          'Official No: ' || v_official_no)),
                muliple_replace_fun (
                   v_body,
                   NEW t_text ('(Additional Auditor Name)',
                               'Auditor/ Inspector: ___',
                               'Audit Type:____',
                               'Audit Subtype:___',
                               'IMO No.:___',
                               'Official No.:____'),
                   NEW t_text (
                          v_auditor_name,
                          (SELECT CASE
                                     WHEN :new.AUDIT_TYPE_ID IN (1003, 1005)
                                     THEN
                                        'Inspector'
                                     ELSE
                                        'Auditor'
                                  END
                             FROM DUAL)
                          || ' '
                          || v_lead_name,
                          audit_desc_msg || ' Type: ' || audit_type_desc,
                             audit_desc_msg
                          || ' Subtype: '
                          || audit_subtype_desc,
                          'IMO No: ' || v_vessel_imo_no,
                          ' No: ' || v_official_no))
           INTO v_subject, v_body
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_typeid
                                AND audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_subtype_desc,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_official_no,
                        (SELECT first_name || ' ' || last_name
                           FROM ma_users
                          WHERE user_id = v_auditor_id
                                AND company_id = v_company_id)
                           v_auditor_name,
                        (SELECT first_name || ' ' || last_name
                           FROM audit_auditor_details aad, ma_users mu
                          WHERE     aad.user_id = mu.user_id
                                AND aad.company_id = mu.company_id
                                AND aad.aud_lead_status = 1
                                AND aad.audit_role_id IN
                                       (SELECT audit_role_id
                                          FROM ma_audit_roles
                                         WHERE REGEXP_LIKE (audit_role_desc,
                                                            'AUDITOR')
                                               AND company_id = v_company_id)
                                AND aad.audit_seq_no = v_audit_seq_no
                                AND aad.company_id = v_company_id)
                           v_lead_name
                   FROM DUAL) test;

         v_cc := v_auditors || ',' || v_admin || ',' || v_manager;

         audit_send_mail_prc (
            'ADelegating Signature ' || v_audit_seq_no,
            v_company_id,
            v_from,
            vLeadAud,
            v_cc,
            v_subject,
            v_body);
      END IF;
   
   
   
     END IF;

      IF (    :OLD.AUD_SIGNATURE IS NULL
          AND :NEW.AUD_SIGNATURE IS NOT NULL
          AND v_audit_role_id = 1003
          AND v_audit_status_id = 1002)
      THEN
         SELECT subject, body
           INTO v_subject, v_body
           FROM audit_email_dtls
          WHERE email_seq = 72;

         SELECT muliple_replace_fun (
                   v_subject,
                   NEW t_text ('Audit',
                               'Type:__',
                               'Subtype:__',
                               'Vessel:__'),
                   NEW t_text (audit_desc_msg,
                               'Type: ' || audit_type_desc,
                               'Subtype: ' || audit_subtype_desc,
                               'Vessel: ' || v_vessel_name)),
                muliple_replace_fun (
                   v_body,
                   NEW t_text ('Audit/Inspection/ Review',
                               'type:__',
                               'Subtype:__',
                               'Vessel:___',
                               'IMO No.:___',
                               'Official No.:___'),
                   NEW t_text (audit_desc_msg,
                               'Type: ' || audit_type_desc,
                               'Subtype: ' || audit_subtype_desc,
                               'Vessel: ' || v_vessel_name,
                               'IMO No: ' || v_vessel_imo_no,
                               'Official No: ' || v_official_no))
           INTO v_subject, v_body
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_typeid
                                AND audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_subtype_desc,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_official_no,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                AND COMPANY_ID = v_company_id)
                           v_vessel_name
                   FROM DUAL) test;


         v_cc := v_reviewer || ',' || v_admin || ',' || v_manager;


         audit_send_mail_prc ('Audit completion' || v_audit_seq_no,
                              v_company_id,
                              v_from,
                              vLeadAud,
                              v_cc,
                              v_subject,
                              v_body);
      END IF;

      IF (    :OLD.AUD_SIGNATURE IS NULL
          AND :NEW.AUD_SIGNATURE IS NOT NULL
          AND v_audit_role_id = 1001)
      THEN
         IF :old.AUDIT_TYPE_ID IN (1004, 1005)
         THEN
            audit_desc_msg := 'Review';
         ELSIF :old.AUDIT_TYPE_ID IN (1003)
         THEN
            audit_desc_msg := 'Inspection';
         ELSE
            audit_desc_msg := 'Audit';
         END IF;

         SELECT COUNT (*)
           INTO v_additional_auditor_count
           FROM AUDIT_AUDITOR_DETAILS
          WHERE     audit_Seq_no = v_audit_seq_no
                AND audit_role_id = v_audit_role_id
                AND aud_lead_status <> 1
                AND USER_ID <> v_user_id
                AND aud_signature IS NULL;

         IF (v_additional_auditor_count = 0)
         THEN
            SELECT subject, body
              INTO v_subject, v_body
              FROM audit_email_dtls
             WHERE email_seq = 22;

            SELECT muliple_replace_fun (
                      v_body,
                      NEW t_text ('Auditors',
                                  'Audit type__',
                                  'Audit Subtype__',
                                  'Vessel:__',
                                  'IMO No.:___',
                                  'Official No.:___'),
                      NEW t_text (
                             (SELECT CASE
                                        WHEN audit_desc_msg = 'Audit'
                                        THEN
                                           'Auditors'
                                        WHEN audit_desc_msg = 'Inspection'
                                        THEN
                                           'Inspector'
                                     END
                                FROM DUAL),
                             audit_desc_msg || ' Type: ' || audit_type_desc,
                                audit_desc_msg
                             || ' Subtype: '
                             || audit_subtype_desc,
                             'Vessel: ' || v_vessel_name,
                             'IMO No: ' || v_vessel_imo_no,
                             'Official No: ' || v_official_no))
              INTO v_body
              FROM (SELECT (SELECT audit_type_desc
                              FROM ma_audit_type
                             WHERE audit_type_id = v_audit_type
                                   AND company_id = v_company_id)
                              audit_type_desc,
                           (SELECT audit_subtype_desc
                              FROM ma_audit_subtype
                             WHERE     audit_sub_type_id = v_audit_sub_typeid
                                   AND audit_type_id = v_audit_type
                                   AND company_id = v_company_id)
                              audit_subtype_desc,
                           (SELECT OFFICIAL_NO
                              FROM MA_VESSEL
                             WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                   AND COMPANY_ID = v_company_id)
                              v_official_no,
                           (SELECT VESSEL_NAME
                              FROM MA_VESSEL
                             WHERE VESSEL_IMO_NO = v_vessel_imo_no
                                   AND COMPANY_ID = v_company_id)
                              v_vessel_name
                      FROM DUAL) test;


            v_cc := v_manager || ',' || v_admin;


            audit_send_mail_prc ('Trigger Initiate' || v_audit_seq_no,
                                 v_company_id,
                                 v_from,
                                 vLeadAud,
                                 v_cc,
                                 v_subject,
                                 v_body);
         END IF;
      END IF;
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      SELECT subject
        INTO v_subject
        FROM audit_email_dtls
       WHERE email_seq = 35;

      vErrMsg := SQLERRM || ' on ' || DBMS_UTILITY.format_error_backtrace;
      audit_send_mail_prc (
         p_audit_no     => 'reviewer removed his sign for' || v_audit_seq_no,
         p_company_id   => v_company_id,
         p_from_mail    => audit_details_pkg.v_From,
         p_to_mail      => audit_details_pkg.V_BSOLTEAM,
         p_subject      => V_SUBJECT,
         p_body         => vErrMsg);
END;
/
