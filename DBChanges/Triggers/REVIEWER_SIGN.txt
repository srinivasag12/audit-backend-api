DROP TRIGGER AUDIT_STAG_TEST.REVIEWER_SIGN;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST.reviewer_sign
after update 
ON AUDIT_STAG_TEST.AUDIT_AUDITOR_DETAILS for each row
DISABLE
declare
v_audit_sub_typeid number;
audit_desc_msg varchar2(200);
v_audit_seq_no number;
v_vessel_imo_no varchar2(200);
v_audit_type number;
v_audit_subtype number;
v_subject varchar2(2000);
v_body varchar2(2000);
v_cc varchar2(200);
v_from varchar2(200):='iri@bsolsystems.com';
v_admin varchar2(200);
vleadaud varchar2(200);
v_company_id number;

v_reviewer varchar2(200);
v_manager varchar2(500);
v_old_aud_signature blob;
v_new_aud_signature blob;
v_aud_lead_status number;
--v_audit_type_id number;
--added because of mutating error
PRAGMA AUTONOMOUS_TRANSACTION;
begin
if updating then
if :new.aud_signature is null then
v_audit_type:=:old.audit_type_id;
v_company_id:=:new.company_id;
v_audit_seq_no:=:new.audit_seq_no;
v_old_aud_signature:=:old.aud_signature;
v_new_aud_signature:=:new.aud_signature;
v_aud_lead_status:=:new.aud_lead_status;
dbms_output.put_line(v_company_id);
dbms_output.put_line(v_audit_seq_no);
--dbms_output.put_line(v_old_aud_signature);
--dbms_output.put_line(v_new_aud_signature);
dbms_output.put_line(v_aud_lead_status);
dbms_output.put_line(v_audit_type);
--to pick leadaudit(v_to)
if v_old_aud_signature is not null then
dbms_output.put_line('step1');
-- to pick leadaudit
select user_id into vleadaud from audit_auditor_details where  audit_seq_no=v_audit_seq_no 
and audit_role_id=1001
and company_id=v_company_id
and aud_lead_status=1;
dbms_output.put_line(vleadaud);
-- to pick reviewer
select  nvl ( (select user_id  from audit_auditor_details where audit_seq_no=v_audit_seq_no 
and company_id=v_company_id and aud_lead_status=0 and audit_role_id=1003),'')  
into v_reviewer  from dual;
--select user_id into v_reviewer from audit_auditor_details where
--audit_seq_no=v_audit_seq_no
--and company_id=v_company_id
--and aud_lead_status=0
--and audit_role_id=1003;
dbms_output.put_line(v_reviewer);
  -- to pick mnanager
 -- select user_id into v_manager from ma_user_roles where role_id=1003;
  SELECT listAgg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_manager
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1003;


 dbms_output.put_line(v_manager); 
  --to pick admin
SELECT listAgg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 and company_id=v_company_id;
dbms_output.put_line(v_admin);
if :old.audit_role_id=1003 and :old.aud_lead_status=0 then
dbms_output.put_line('step2');
 IF :old.AUDIT_TYPE_ID IN (1004, 1005)
         THEN
         audit_desc_msg := 'Review';
         ELSIF :old.AUDIT_TYPE_ID IN (1003)
         THEN
            audit_desc_msg := 'Inspection';
         ELSE
            audit_desc_msg := 'Audit';
         END IF;
         dbms_output.put_line('step3'||audit_desc_msg);
select subject,body into v_subject,v_body from audit_email_dtls where email_seq=35;
dbms_output.put_line(v_body);
                   dbms_output.put_line(v_subject);

select vessel_imo_no,audit_sub_type_id into v_vessel_imo_no,v_audit_sub_typeid from audit_details 
where audit_seq_no=v_audit_seq_no and company_id=v_company_id
and audit_type_id=v_audit_type;
dbms_output.put_line(v_vessel_imo_no);
dbms_output.put_line(v_audit_sub_typeid);
SELECT muliple_replace_fun (
                   v_subject,
                   NEW t_text ('Audit ___  with','IMO No.___'),
                   NEW t_text (audit_desc_msg || '  ' || audit_type_desc||' with',
                               ' IMO No. ' || v_vessel_imo_no)),
                muliple_replace_fun (
                   v_body,
                   NEW t_text ('Audit Subtype:__,',
                               'Audit Type:__,',
                               'Vessel IMO No.:__'),
                   NEW t_text (
                             audit_desc_msg
                          || ' Subtype: '
                          || audit_subtype_desc,
                          audit_desc_msg || ' Type: ' || audit_type_desc,
                          'Vessel IMO No. ' || v_vessel_imo_no))
           INTO v_subject, v_body FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_type_desc,
                        (SELECT audit_subtype_desc
                           FROM ma_audit_subtype
                          WHERE     audit_sub_type_id = v_audit_sub_typeid
                                AND audit_type_id = v_audit_type
                                AND company_id = v_company_id)
                           audit_subtype_desc
                   FROM DUAL) test;
                   dbms_output.put_line(v_body);
                   dbms_output.put_line(v_subject);
                   v_cc:=v_reviewer||','||v_admin||','||v_manager;
                   if v_new_aud_signature is null then
                   dbms_output.put_line('step4');
                   audit_send_mail_prc('reviewer removed his sign for'||v_audit_seq_no,
                   v_company_id,
                   v_from,
                   vLeadAud,
                   v_cc,
                   v_subject,
                   v_body);

end if;
end if;
end if;
end if;
end if;
end;
/
