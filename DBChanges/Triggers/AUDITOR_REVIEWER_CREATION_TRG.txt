DROP TRIGGER AUDIT_STAG_TEST.AUDITOR_REVIEWER_CREATION_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."AUDITOR_REVIEWER_CREATION_TRG"
   AFTER INSERT OR DELETE
   ON AUDIT_STAG_TEST.AUDIT_AUDITOR_DETAILS    FOR EACH ROW
DECLARE
   v_admin               VARCHAR2 (200);
   vAudSeqNo             VARCHAR2 (50);
   vCompanyId            NUMBER;
   vFrom                 VARCHAR2 (30) := audit_details_pkg.v_From;
   vType                 VARCHAR2 (20);
   vTo                   VARCHAR2 (1000);
   vAuditor              VARCHAR2 (30);
   vSubject              VARCHAR2 (30000);
   vBdy                  VARCHAR2 (30000);
   vSub                  VARCHAR2 (30000);
   vBody                 VARCHAR2 (30000);
   vAudType              VARCHAR2 (30);
   vVslImoNo             VARCHAR2 (30);
   vAudSubType           VARCHAR2 (30);
   vMgr                  VARCHAR2 (500);
   vAccssLink            VARCHAR2 (1000);
   vCC                   VARCHAR2 (1000);
   vErrMsg               VARCHAR2 (500);
   vUser                 VARCHAR2 (30);
   vAudRoleId            NUMBER;
   vAudLeadStatus        NUMBER;
   vAudTypeId            NUMBER;
   vInsBy                VARCHAR2 (50);
   vRole                 VARCHAR2 (30);
   vInsRole              NUMBER;
   v_lead_audit          VARCHAR2 (200);
   audit_desc_msg        VARCHAR2 (100);
   v_user_Name           VARCHAR2 (100);
   v_role_desc           VARCHAR2 (100);
   v_count_audit         NUMBER;
   v_admin_mgr_id        VARCHAR2 (30);
   v_mgr_name            VARCHAR2 (30);
   v_vessel_name         VARCHAR2 (200);
   v_official_no         NUMBER;
   v_aud_count           NUMBER;
   v_aud_auditor_count   NUMBER;


   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   IF INSERTING
   THEN
      vType := 'Added';
      vAudSeqno := :new.Audit_seq_no;
      vTo := :new.user_id;
      vCompanyId := :new.company_id;
      vAudRoleId := :new.audit_role_id;
      vAudLeadStatus := :New.aud_lead_status;
      vAudTypeId := :new.audit_type_id;
      vInsBy := :new.user_ins;

      SELECT subject, body
        INTO vSubject, vBdy
        FROM audit_email_dtls
       WHERE email_seq = 52;
   ELSIF DELETING
   THEN
      vType := 'Removed';
      vAudSeqno := :old.Audit_seq_no;
      vTo := :old.user_id;
      vCompanyId := :old.company_id;
      vAudRoleId := :old.audit_role_id;
      vAudLeadStatus := :old.aud_lead_status;
      vAudTypeId := :old.audit_type_id;
      vInsBy := :old.user_ins;

      SELECT subject, body
        INTO vSubject, vBdy
        FROM audit_email_dtls
       WHERE email_seq = 51;
   END IF;


   SELECT (CASE
              WHEN a.ROLE_ID = 1002 THEN 'Admin'
              WHEN a.ROLE_ID = 1003 THEN 'Manager'
           END)
     INTO v_admin_mgr_id
     FROM ma_roles a, ma_user_roles b
    WHERE     A.ROLE_ID = B.ROLE_ID
          AND A.COMPANY_ID = B.COMPANY_ID
          AND B.USER_ID = vInsBy
          AND B.COMPANY_ID = vCompanyId;


   CASE
      WHEN vAudRoleId = 1001 AND vAudLeadStatus = 0
      THEN
         vAuditor := 'Auditor';
      WHEN vAudRoleId = 1001 AND vAudLeadStatus = 1
      THEN
         IF vAudTypeId IN (1003)
         THEN
            vAuditor := 'Lead Inspector';
         ELSE
            vAuditor := 'Lead Auditor';
         END IF;
      WHEN vAudRoleId = 1003 AND vAudLeadStatus = 0
      THEN
         vAuditor := 'Reviewer';
      WHEN vAudRoleId = 1002 AND vAudLeadStatus = 0
      THEN
         vAuditor := 'Observer';
      ELSE
         vAuditor := 'null';
   END CASE;

   SELECT role_id
     INTO vInsRole
     FROM ma_user_roles
    WHERE user_id = vInsBy AND company_id = vCompanyId;

   CASE
      WHEN vInsRole = 1001
      THEN
         vRole := 'Lead';
      WHEN vInsRole = 1002
      THEN
         vRole := 'Admin';
      WHEN vInsRole = 1003
      THEN
         vRole := 'Manager';
          WHEN vInsRole = 1006
      THEN
         vRole := 'IHM Manager';
         ELSE
         vRole := 'No Role';
         
   END CASE;

   IF vAudTypeId IN (1004, 1005)
   THEN
      audit_desc_msg := 'Review';
   ELSIF vAudTypeId IN (1003)
   THEN
      audit_desc_msg := 'Inspection';
   ELSIF vAudTypeId IN (1001, 1002)
   THEN
      audit_desc_msg := 'Audit';
   END IF;

   IF (vType = 'Removed')
   THEN
      SELECT user_id
        INTO v_lead_audit
        FROM audit_auditor_details
       WHERE     audit_seq_no = vAudSeqno
             AND audit_role_id = 1001
             AND aud_lead_status = 1
             AND audit_type_id = vAudTypeId;

      SELECT vessel_imo_no
        INTO vVslImoNo
        FROM audit_details
       WHERE audit_seq_no = vAudSeqno AND company_id = vCompanyId;


      IF (v_admin_mgr_id IS NULL AND :old.aud_lead_status = 1)
      THEN
         SELECT muliple_replace_fun (
                   vSubject,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'Audit (Type:___, Subtype:__)',
                               'Vessel:__',
                               'IMO No.:___',
                               'and O.N.:__'),
                   NEW t_text (
                          vAuditor || ' ',
                             audit_desc_msg
                          || '(Type: '
                          || vAudType
                          || ', Sub Type: '
                          || vAudSubType
                          || ')',
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          '& Official No: ' || v_official_no)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text (' Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'Audit Sub Type:___',
                               'Audit Type: ___',
                               'Vessel:__',
                               'IMO No.:___',
                               'O.N.:__'),
                   NEW t_text (
                          ' ' || vAuditor || ' ',
                          audit_desc_msg || ' Sub Type: ' || vAudSubType,
                          audit_desc_msg || 'Type :' || vAudType,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSub, vBody
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           vAudType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType
                   FROM DUAL) test;
      END IF;

      IF (v_admin_mgr_id IS NOT NULL AND :old.aud_lead_status = 1)
      THEN
         SELECT muliple_replace_fun (
                   vSubject,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'Audit (Type:___, Subtype:__)',
                               'Vessel:__',
                               'IMO No.:___',
                               'and O.N.:__'),
                   NEW t_text (
                          vAuditor || ' ',
                             audit_desc_msg
                          || '(Type: '
                          || vAudType
                          || ', Sub Type: '
                          || vAudSubType
                          || ')',
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          '& Official No: ' || v_official_no)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text (' Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'Audit Sub Type:___',
                               'Audit Type: ___',
                               'Vessel:__',
                               'IMO No.:___',
                               'O.N.:__'),
                   NEW t_text (
                          ' ' || vAuditor || ' ',
                          audit_desc_msg || ' Sub Type: ' || vAudSubType,
                          audit_desc_msg || 'Type :' || vAudType,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSub, vBody
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           vAudType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType
                   FROM DUAL) test;
      END IF;

      IF (v_admin_mgr_id IS NULL AND :old.aud_lead_status = 0)
      THEN
         SELECT subject, body
           INTO vSubject, vBdy
           FROM audit_email_dtls
          WHERE email_seq = 52;

         SELECT muliple_replace_fun (
                   vSubject,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'added/ replaced/ removed',
                               'by Lead'),
                   NEW t_text (vAuditor, 'removed', 'by ' || 'the ' || vRole)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'added/ replaced/ removed',
                               'by the__',
                               'Audit Type:__',
                               'Audit Subtype:__',
                               'Audit /Inspection/ Review',
                               'Vessel:__',
                               'IMO No.:___',
                               'Official No:___'),
                   NEW t_text (
                          vAuditor,
                          'removed',
                          'by ' || 'the ' || vRole,
                          audit_desc_msg || ' Type :' || vAudType,
                          audit_desc_msg || ' Sub Type: ' || vAudSubType,
                          audit_desc_msg,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSub, vBody
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           vAudType,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no,
                        (SELECT first_name || ' ' || last_name
                           FROM ma_users
                          WHERE USER_ID = vTo AND company_id = vCompanyId)
                           v_user_Name
                   FROM DUAL) test;
      END IF;

      IF (    vAudRoleId = 1003
          AND v_admin_mgr_id IS NOT NULL
          AND (v_admin_mgr_id = 'Admin' OR v_admin_mgr_id = 'Manager'))
      THEN
         SELECT subject, body
           INTO vSubject, vBdy
           FROM audit_email_dtls
          WHERE email_seq = 77;

         SELECT muliple_replace_fun (vSubject,
                                     NEW t_text ('Admin/Manager'),
                                     NEW t_text (v_admin_mgr_id)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text ('following Audit:',
                               'Audit Sub Type:___',
                               'Audit Type: ___',
                               'IMO No.___',
                               'Offcial No.:___ '),
                   NEW t_text (
                          'following ' || audit_desc_msg,
                          audit_desc_msg || ' Subtype: ' || vAudSubType,
                          audit_desc_msg || ' type: ' || audit_type_desc,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSubject, vBdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           audit_type_desc,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no
                   FROM DUAL) test;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO vMgr
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1003 AND company_id = vCompanyId;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_admin
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1002 AND company_id = vCompanyId;

         SELECT user_id
           INTO v_lead_audit
           FROM audit_auditor_details
          WHERE     audit_seq_no = vAudSeqno
                AND audit_role_id = 1001
                AND aud_lead_status = 1
                AND audit_type_id = vAudTypeId;


         vCC := v_lead_audit || ',' || vMgr || ',' || v_admin;

         audit_send_mail_prc (
            'reviewer removed by ' || v_admin_mgr_id || ' ' || vAudSeqno,
            vCompanyId,
            vFrom,
            :old.user_id,
            vCC,
            vSubject,
            vBdy);
      END IF;
   END IF;

   IF (vType = 'Added')
   THEN
      SELECT COUNT (audit_seq_no)
        INTO v_count_audit
        FROM audit_details
       WHERE audit_seq_no = vAudSeqno AND company_id = vCompanyId;

      SELECT role_id
        INTO vInsRole
        FROM ma_user_roles
       WHERE user_id = vInsBy AND company_id = vCompanyId;

      CASE
         WHEN vInsRole = 1001
         THEN
            vRole := 'Lead';
         WHEN vInsRole = 1002
         THEN
            vRole := 'Admin';
         WHEN vInsRole = 1003
         THEN
            vRole := 'Manager';
              WHEN vInsRole = 1006
      THEN
         vRole := 'IHM Manager';
         ELSE
         vRole := 'No Role';
      END CASE;

      IF (v_count_audit > 0 AND v_admin_mgr_id IS NULL)
      THEN
         SELECT vessel_imo_no
           INTO vVslImoNo
           FROM audit_details
          WHERE audit_seq_no = vAudSeqno AND company_id = vCompanyId;

         IF vAudLeadStatus <> 1
         THEN
            SELECT user_id
              INTO v_lead_audit
              FROM audit_auditor_details
             WHERE     audit_seq_no = vAudSeqno
                   AND audit_role_id = 1001
                   AND aud_lead_status = 1
                   AND audit_type_id = vAudTypeId;
         END IF;

         SELECT muliple_replace_fun (
                   vSubject,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'added/ replaced/ removed',
                               'by Lead'),
                   NEW t_text (vAuditor, 'added', 'by ' || 'the ' || vRole)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text ('Lead Auditor/ Auditor/ Observer/ Reviewer',
                               'added/ replaced/ removed',
                               'by the__',
                               'Audit Type:__',
                               'Audit Subtype:__',
                               'Audit /Inspection/ Review',
                               'Vessel:__',
                               'IMO No.:___',
                               'Official No:___'),
                   NEW t_text (
                          vAuditor,
                          'added',
                          'by ' || 'the ' || vRole,
                          audit_desc_msg || ' Type :' || vAudType,
                          audit_desc_msg || ' Sub Type: ' || vAudSubType,
                          audit_desc_msg,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSub, vBody
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           vAudType,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no,
                        (SELECT first_name || ' ' || last_name
                           FROM ma_users
                          WHERE USER_ID = vTo AND company_id = vCompanyId)
                           v_user_Name
                   FROM DUAL) test;
      END IF;

      IF (    v_count_audit > 0
          AND vAudRoleId = 1003
          AND v_admin_mgr_id IS NOT NULL
          AND (v_admin_mgr_id = 'Admin' OR v_admin_mgr_id = 'Manager'))
      THEN
         SELECT subject, body
           INTO vSubject, vBdy
           FROM audit_email_dtls
          WHERE email_seq = 75;

         SELECT vessel_imo_no
           INTO vVslImoNo
           FROM audit_details
          WHERE audit_seq_no = vAudSeqno AND company_id = vCompanyId;

         SELECT muliple_replace_fun (vSubject,
                                     NEW t_text ('Admin/Manager'),
                                     NEW t_text (v_admin_mgr_id)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text ('Admin/Manager',
                               'Audit Type:___',
                               'Audit Subtype:___',
                               'Audit/ Inspection/ Review',
                               'Vessel:__',
                               'IMO No.____',
                               'Offcial No.:___'),
                   NEW t_text (
                          v_admin_mgr_id,
                          audit_desc_msg || ' type: ' || audit_type_desc,
                          audit_desc_msg || ' Subtype: ' || vAudSubType,
                          audit_desc_msg,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no))
           INTO vSubject, vBdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           audit_type_desc,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no
                   FROM DUAL) test;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO vMgr
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1003 AND company_id = vCompanyId;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_admin
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1002 AND company_id = vCompanyId;

         SELECT user_id
           INTO v_lead_audit
           FROM audit_auditor_details
          WHERE     audit_seq_no = vAudSeqno
                AND audit_role_id = 1001
                AND aud_lead_status = 1
                AND audit_type_id = vAudTypeId;


         vCC := v_lead_audit || ',' || vMgr || ',' || v_admin;

         audit_send_mail_prc (
            'reviewer added by ' || v_admin_mgr_id || ' ' || vAudSeqno,
            vCompanyId,
            vFrom,
            :new.user_id,
            vCC,
            vSubject,
            vBdy);
      END IF;

      IF (    v_count_audit > 0
          AND vAudRoleId = 1003
          AND v_admin_mgr_id IS NOT NULL
          AND v_admin_mgr_id = 'Manager')
      THEN
         SELECT subject, body
           INTO vSubject, vBdy
           FROM audit_email_dtls
          WHERE email_seq = 76;

         SELECT vessel_imo_no
           INTO vVslImoNo
           FROM audit_details
          WHERE audit_seq_no = vAudSeqno AND company_id = vCompanyId;

         SELECT muliple_replace_fun (
                   vSubject,
                   NEW t_text ('Audit (Type:__, Subtype:__)',
                               'Vessel:__',
                               'IMO No.:___',
                               'and Official No.:___'),
                   NEW t_text (
                             audit_desc_msg
                          || '(Type: '
                          || audit_type_desc
                          || ' Sub Type: '
                          || vAudSubType
                          || ')',
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          '&' || ' Official No: ' || v_official_no)),
                muliple_replace_fun (
                   vBdy,
                   NEW t_text ('Audit type__',
                               'Audit Subtype__',
                               'Vessel:__',
                               'IMO No.:___',
                               'Official No.:___',
                               'Manager__'),
                   NEW t_text (
                          audit_desc_msg || ' type: ' || audit_type_desc,
                          audit_desc_msg || ' Subtype: ' || vAudSubType,
                          'Vessel: ' || v_vessel_name,
                          'IMO No: ' || vVslImoNo,
                          'Official No: ' || v_official_no,
                          'Manager ' || v_mgr_name))
           INTO vSubject, vBdy
           FROM (SELECT (SELECT audit_type_desc
                           FROM ma_audit_type
                          WHERE audit_type_id = vAudTypeId
                                AND company_id = vCompanyId)
                           audit_type_desc,
                        (SELECT b.audit_subtype_desc
                           FROM audit_details a, ma_audit_subtype b
                          WHERE     a.audit_type_id = b.audit_type_id
                                AND a.audit_sub_type_id = b.audit_sub_type_id
                                AND a.company_id = b.company_id
                                AND a.audit_seq_no = vAudSeqno
                                AND a.company_id = vCompanyId)
                           vAudSubType,
                        (SELECT VESSEL_NAME
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_vessel_name,
                        (SELECT OFFICIAL_NO
                           FROM MA_VESSEL
                          WHERE VESSEL_IMO_NO = vVslImoNo
                                AND COMPANY_ID = vCompanyId)
                           v_official_no,
                        (SELECT first_name || ' ' || last_name
                           FROM ma_users
                          WHERE USER_ID = vInsBy AND company_id = vCompanyId)
                           v_mgr_name
                   FROM DUAL) test;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO vMgr
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1003 AND company_id = vCompanyId;

         SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
           INTO v_admin
           FROM MA_USER_ROLES USRL
          WHERE USRL.ROLE_ID = 1002 AND company_id = vCompanyId;

         SELECT user_id
           INTO v_lead_audit
           FROM audit_auditor_details
          WHERE     audit_seq_no = vAudSeqno
                AND audit_role_id = 1001
                AND aud_lead_status = 1
                AND audit_type_id = vAudTypeId;

         vCC := v_lead_audit || ',' || vMgr || ',' || v_admin;

         audit_send_mail_prc (
               'reviewer added by the manager '
            || v_admin_mgr_id
            || ' '
            || vAudSeqno,
            vCompanyId,
            vFrom,
            :new.user_id,
            vCC,
            vSubject,
            vBdy);
      END IF;
   END IF;

   SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO vMgr
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1003 AND company_id = vCompanyId;

   SELECT listAgg (user_id, ',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 AND company_id = vCompanyId;

   IF (vAuditor <> 'Lead Auditor' AND vAuditor <> 'Lead Inspector')
   THEN
      vCC := v_lead_audit || ',' || vMgr || ',' || v_admin;
   ELSE
      vCC := vMgr || ',' || v_admin;
   END IF;

   /*
dbms_output.put_line('step4');
   SELECT subject, body
     INTO vSubject, vBdy
     FROM audit_email_dtls
    WHERE email_seq = 24;

dbms_output.put_line('step5');
   SELECT muliple_replace_fun (
             vSubject,
             NEW t_text ('Auditor', 'added/replaced/remeoved', 'by Lead'),
             NEW t_text (vAuditor || ' ', vType || ' ', 'by ' || vRole)),
          muliple_replace_fun (
             vBdy,
             NEW t_text ('Additional Auditor/Observer/Reviewer',
                         'added/replaced /removed',
                         '_Audit Type',
                         'Audit Subtype',
                         'IMO No.____',
                         'by the Lead'),
             NEW t_text (vAuditor || ' ',
                         vType || ' ',
                         'Audit Type ' || vAudType,
                         'Audit Subtype ' || vAudSubType,
                         'IMO No ' || vVslImoNo,
                         'by the ' || vRole))
     INTO vSub, vBody
     FROM DUAL;

dbms_output.put_line('step6');

  dbms_output.put_line(vTo);
dbms_output.put_line(vCC);
dbms_output.put_line(vSub);
dbms_output.put_line(vBody);*/

   IF vSub IS NOT NULL AND vBody IS NOT NULL
   THEN
      vAccssLink :=
            vAuditor
         || '  '
         || vType
         || ' for the vessel is '
         || vVslImoNo
         || 'WIth Audit '
         || vAudSeqno;

      audit_send_mail_prc (vAccssLink,
                           vCompanyId,
                           vFrom,
                           vTo,
                           vCC,
                           vSub,
                           vBody);
   END IF;
EXCEPTION
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line (
            '  OUTER BLOCK EXCEPTION '
         || SQLCODE
         || ' >> '
         || SQLERRM
         || '  >> '
         || DBMS_UTILITY.format_error_backtrace);
      vErrMsg := SQLERRM || ' on ' || DBMS_UTILITY.format_error_backtrace;

      audit_send_mail_prc (p_audit_no     => vAccssLink,
                           p_company_id   => vCompanyId,
                           p_from_mail    => audit_details_pkg.v_From,
                           p_to_mail      => audit_details_pkg.V_BSOLTEAM,
                           p_subject      => vSub,
                           p_body         => vErrMsg);
END;
/
