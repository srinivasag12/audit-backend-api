DROP TRIGGER AUDIT_STAG_TEST.LASTFINDINGUP_TRG;

CREATE OR REPLACE TRIGGER AUDIT_STAG_TEST."LASTFINDINGUP_TRG" 
before update 
ON AUDIT_STAG_TEST.AUDIT_FINDINGS_DETAILS FOR EACH ROW
DISABLE
declare
v_body1 varchar2(200);
v_prevLaudit varchar2(200);
v_cur_audit varchar2(200);
v_manager varchar2(200);
v_aud_sub_type varchar2(200);
v_aud_type varchar2(200);
v_from varchar2(200):= audit_details_pkg.v_From;
v_to varchar2(200);
v_cc varchar2(200);
v_audit_type number;
v_audit_sub_type number;
v_vessel_imo_no varchar2(200);
v_status_seq_no number;
v_cur_audit_seq_no number;
v_orig_seq_no number;
v_finding_seq_no number;
v_finding_category_id number;
v_status_id number;
v_status_date date;
v_next_action_id number;
v_due_date varchar2(200);
v_description varchar2(2000);
v_company_id number;
v_user_ins varchar2(200);
v_date_ins date;
v_audit_type_id number;
v_admin varchar2(200);
v_subject varchar2(200);
v_body varchar2(200);
 PRAGMA AUTONOMOUS_TRANSACTION;
begin
dbms_output.put_line('step1');
v_status_seq_no:=:new.status_seq_no;
v_cur_audit_seq_no:=:new.cur_audit_seq_no;
v_orig_seq_no:=:new.orig_seq_no;
v_finding_seq_no:=:new.finding_seq_no;
v_finding_category_id:=:new.finding_category_id;
v_status_id:=:new.status_id;
v_status_date:=:new.status_date;
v_next_action_id:=:new.next_action_id;
v_due_date:=:new.due_date;
v_description:=:new.description;
v_company_id:=:new.company_id;
v_user_ins:=:new.user_ins;-- current auditor
v_date_ins:=:new.date_ins;
v_audit_type_id:=:new.audit_type_id;
dbms_output.put_line(v_status_seq_no);
dbms_output.put_line(v_cur_audit_seq_no);
dbms_output.put_line(v_orig_seq_no);
dbms_output.put_line(v_finding_seq_no);
dbms_output.put_line(v_finding_category_id);
dbms_output.put_line(v_status_id);
dbms_output.put_line(v_status_date);
dbms_output.put_line(v_next_action_id);
dbms_output.put_line(v_due_date);
dbms_output.put_line(v_description);
dbms_output.put_line(v_company_id);
dbms_output.put_line(v_user_ins);
dbms_output.put_line(v_date_ins);
dbms_output.put_line(v_audit_type_id);
--to pick admin
dbms_output.put_line('step2');
SELECT listAgg (user_id,',') WITHIN GROUP (ORDER BY role_id ASC)
     INTO v_admin
     FROM MA_USER_ROLES USRL
    WHERE USRL.ROLE_ID = 1002 and company_id=v_company_id;
 dbms_output.put_line(v_admin);
 -- to pick manager
 dbms_output.put_line('step3');
 
 select  nvl ( (select USER_ID  from MA_USER_ROLES where COMPANY_ID=v_company_id and ROLE_ID=1003),'') into v_manager  from dual;
 
 dbms_output.put_line(v_manager);
 --- to pick vessel imo num and audit_sub_tpe
 dbms_output.put_line('step4');
 select vessel_imo_no,audit_sub_type_id into v_vessel_imo_no,v_audit_sub_type from audit_details where audit_seq_no=v_cur_audit_seq_no
 and company_id=v_company_id and audit_type_id=v_audit_type_id;
  dbms_output.put_line(v_vessel_imo_no||v_audit_sub_type);
 --to pick sub_type desc and audit type desc
 dbms_output.put_line('step6');
 SELECT AUDIT_TYPE_DESC
                 INTO v_aud_type
                 FROM ma_audit_type
                WHERE audit_type_id = v_audit_type_id
                      AND company_id = v_company_id;

               DBMS_OUTPUT.put_line ('v_aud_type ' || v_aud_type);
dbms_output.put_line('step7');
               SELECT AUDIT_SUBTYPE_DESC
                 INTO v_aud_sub_type
                 FROM audit_details ad, ma_audit_subtype mast
                WHERE     ad.audit_type_id = mast.audit_type_id
                      AND ad.audit_sub_type_id = mast.audit_sub_type_id
                      AND ad.company_id = mast.company_id
                      AND ad.audit_type_id = v_audit_type_id
                      AND ad.company_id = v_company_id
                      AND ad.audit_seq_no = v_orig_seq_no;

               DBMS_OUTPUT.put_line ('v_aud_sub_type ' || v_aud_sub_type);

 --to pick prevoius auditor
 dbms_output.put_line('step8');
 select user_ins into v_prevLaudit from audit_auditor_details  where audit_seq_no=v_cur_audit_seq_no
 and company_id=v_company_id and audit_type_id=v_audit_type_id and audit_role_id=1001 and aud_lead_status=1;
  dbms_output.put_line(v_prevLaudit);
 -- to pick current auditor
 dbms_output.put_line('step9');
 
 select  nvl ( (select user_ins from audit_auditor_details  where audit_seq_no=v_orig_seq_no
 and company_id=v_company_id and audit_type_id=v_audit_type_id and audit_role_id=1001 and aud_lead_status=1),'') into v_cur_audit  from dual;
 
 
dbms_output.put_line(v_cur_audit);
--collecting email details
dbms_output.put_line('step10');
select subject,body into v_subject,v_body from audit_email_dtls where email_seq=43;
dbms_output.put_line(v_subject||v_body);
dbms_output.put_line('step11');
  select muliple_replace_fun(v_body,
new t_text('Audit Subtype:__','Audit Type:__','Vessel IMO No.___'),
new t_text('Audit Subtype:'||v_aud_sub_type,
'Audit Type:'||v_aud_type,
'Vessel IMO No.'||v_vessel_imo_no))into v_body1 from audit_email_dtls where email_seq=43;

v_cc:= v_admin;


--- now sending mail
dbms_output.put_line('step12');
dbms_output.put_line(v_cur_audit_seq_no);
dbms_output.put_line(v_company_id);
dbms_output.put_line(v_from);
dbms_output.put_line(v_prevLaudit);
dbms_output.put_line(v_cc);
dbms_output.put_line(v_subject);
dbms_output.put_line(v_body1);
audit_send_mail_prc('previous finding updated'||v_cur_audit_seq_no,
v_company_id,
v_from,
v_prevLaudit,
v_cc,
v_subject,
v_body1
);
EXCEPTION
   WHEN OTHERS
   THEN
      NULL;
end;
/
