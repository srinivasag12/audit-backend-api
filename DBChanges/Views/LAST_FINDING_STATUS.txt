DROP VIEW AUDIT_STAG_TEST.LAST_FINDING_STATUS;

/* Formatted on 09-08-2022 18:11:06 (QP5 v5.163.1008.3004) */
CREATE OR REPLACE FORCE VIEW AUDIT_STAG_TEST.LAST_FINDING_STATUS
(
   VESSEL_IMO_NO,
   COMPANY_ID,
   AUDIT_DATE,
   AUDIT_TYPE_ID,
   AUDIT_SUB_TYPE_ID,
   AUDIT_SEQ_NO,
   FINDING_SEQ_NO,
   AUDIT_CODE,
   STATUS_SEQ_NO,
   FINDING_CATEGORY_ID,
   STATUS_ID,
   DUE_DATE
)
AS
   (SELECT TEST.VESSEL_IMO_NO,
           TEST.COMPANY_ID,
           TEST.AUDIT_DATE,
           TEST.AUDIT_TYPE_ID,
           TEST.AUDIT_SUB_TYPE_ID,
           TEST.AUDIT_SEQ_NO,
           TEST.FINDING_SEQ_NO,
           TEST.AUDIT_CODE,
           TEST.STATUS_SEQ_NO,
           TEST.FINDING_CATEGORY_ID,
           TEST.STATUS_ID,
           TEST.DUE_DATE
      FROM (SELECT AD.VESSEL_IMO_NO,
                   AD.COMPANY_ID,
                   AD.AUDIT_DATE,
                   AD.AUDIT_TYPE_ID,
                   AD.AUDIT_SUB_TYPE_ID,
                   AD.AUDIT_SEQ_NO,
                   F.FINDING_SEQ_NO,
                   F.AUDIT_CODE,
                   FD.STATUS_SEQ_NO,
                   FD.FINDING_CATEGORY_ID,
                   FD.STATUS_ID,
                   FD.DUE_DATE
              FROM AUDIT_DETAILS AD,
                   AUDIT_FINDINGS F,
                   AUDIT_FINDINGS_DETAILS FD
             WHERE     AD.COMPANY_ID = F.COMPANY_ID
                   AND AD.AUDIT_SEQ_NO = F.AUDIT_SEQ_NO
                   AND F.COMPANY_ID = FD.COMPANY_ID
                   AND F.FINDING_SEQ_NO = FD.FINDING_SEQ_NO
                   AND F.AUDIT_SEQ_NO = FD.ORIG_SEQ_NO
                   AND FD.FINDING_CATEGORY_ID <> 1004) TEST
     WHERE TEST.STATUS_SEQ_NO =
              (  SELECT MAX (STATUS_SEQ_NO)
                   FROM (SELECT AD.VESSEL_IMO_NO,
                                AD.COMPANY_ID,
                                AD.AUDIT_DATE,
                                AD.AUDIT_TYPE_ID,
                                AD.AUDIT_SUB_TYPE_ID,
                                AD.AUDIT_SEQ_NO,
                                F.FINDING_SEQ_NO,
                                F.AUDIT_CODE,
                                FD.STATUS_SEQ_NO,
                                FD.FINDING_CATEGORY_ID,
                                FD.STATUS_ID
                           FROM AUDIT_DETAILS AD,
                                AUDIT_FINDINGS F,
                                AUDIT_FINDINGS_DETAILS FD
                          WHERE AD.COMPANY_ID = F.COMPANY_ID
                                AND AD.AUDIT_SEQ_NO =
                                       F.AUDIT_SEQ_NO
                                AND F.COMPANY_ID =
                                       FD.COMPANY_ID
                                AND F.FINDING_SEQ_NO =
                                       FD.FINDING_SEQ_NO
                                AND (F.AUDIT_SEQ_NO =
                                        FD.ORIG_SEQ_NO)
                                AND FD.FINDING_CATEGORY_ID <>
                                       1004)
               GROUP BY AUDIT_SEQ_NO, FINDING_SEQ_NO, COMPANY_ID
                 HAVING TEST.AUDIT_SEQ_NO = AUDIT_SEQ_NO
                        AND TEST.FINDING_SEQ_NO = FINDING_SEQ_NO));


GRANT INSERT, SELECT, UPDATE ON AUDIT_STAG_TEST.LAST_FINDING_STATUS TO AUDIT_PROD_LOG;
