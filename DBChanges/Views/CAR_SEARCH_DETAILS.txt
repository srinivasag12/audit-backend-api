DROP VIEW AUDIT_STAG_TEST.CAR_SEARCH_DETAILS;

/* Formatted on 09-08-2022 18:09:32 (QP5 v5.163.1008.3004) */
CREATE OR REPLACE FORCE VIEW AUDIT_STAG_TEST.CAR_SEARCH_DETAILS
(
   VESSEL_IMO_NO,
   COMPANY_ID,
   AUDIT_DATE,
   AUDIT_TYPE_ID,
   AUDIT_SUB_TYPE_ID,
   USER_ID,
   AUDIT_SEQ_NO,
   FINDING_SEQ_NO,
   AUDIT_CODE,
   CUR_AUDIT_SEQ_NO,
   ORIG_SEQ_NO,
   STATUS_SEQ_NO,
   FINDING_CATEGORY_ID,
   STATUS_ID,
   STATUS_DATE,
   NEXT_ACTION_ID,
   DUE_DATE,
   DESCRIPTION,
   DATE_INS,
   SERIAL_NO,
   AUDIT_PLACE,
   UPDATE_DESCRIPTION
)
AS
   (SELECT AD.VESSEL_IMO_NO,
           AD.COMPANY_ID,
           AD.AUDIT_DATE,
           AD.AUDIT_TYPE_ID,
           AD.AUDIT_SUB_TYPE_ID,
           AAD.USER_ID,
           AD.AUDIT_SEQ_NO,
           F.FINDING_SEQ_NO,
           F.AUDIT_CODE,
           FD.CUR_AUDIT_SEQ_NO,
           FD.ORIG_SEQ_NO,
           FD.STATUS_SEQ_NO,
           FD.FINDING_CATEGORY_ID,
           FD.STATUS_ID,
           FD.STATUS_DATE,
           FD.NEXT_ACTION_ID,
           FD.DUE_DATE,
           FD.DESCRIPTION,
           FD.DATE_INS,
           F.SERIAL_NO,
           FD.AUDIT_PLACE,
           FD.UPDATE_DESCRIPTION
      FROM AUDIT_DETAILS AD,
           AUDIT_AUDITOR_DETAILS AAD,
           AUDIT_FINDINGS F,
           AUDIT_FINDINGS_DETAILS FD
     WHERE     AD.AUDIT_SEQ_NO = F.AUDIT_SEQ_NO
           AND AD.COMPANY_ID = F.COMPANY_ID
           AND AD.AUDIT_SEQ_NO = AAD.AUDIT_SEQ_NO
           AND AAD.AUD_LEAD_STATUS = 1
           AND F.COMPANY_ID = FD.COMPANY_ID
           AND F.FINDING_SEQ_NO = FD.FINDING_SEQ_NO
           AND ( (F.AUDIT_SEQ_NO = FD.CUR_AUDIT_SEQ_NO
                  AND FD.ORIG_SEQ_NO = F.AUDIT_SEQ_NO)
                OR (F.AUDIT_SEQ_NO = FD.ORIG_SEQ_NO
                    AND 0 <
                           (SELECT COUNT (*)
                              FROM AUDIT_DETAILS
                             WHERE ALLOW_NEXT = 1
                                   AND AUDIT_SEQ_NO = FD.CUR_AUDIT_SEQ_NO))
                OR (F.AUDIT_SEQ_NO = FD.ORIG_SEQ_NO
                    AND FD.CUR_AUDIT_SEQ_NO = 600000)));


GRANT INSERT, SELECT, UPDATE ON AUDIT_STAG_TEST.CAR_SEARCH_DETAILS TO AUDIT_PROD_LOG;
