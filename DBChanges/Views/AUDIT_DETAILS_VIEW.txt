DROP VIEW AUDIT_STAG_TEST.AUDIT_DETAILS_VIEW;

/* Formatted on 09-08-2022 18:07:17 (QP5 v5.163.1008.3004) */
CREATE OR REPLACE FORCE VIEW AUDIT_STAG_TEST.AUDIT_DETAILS_VIEW
(
   USER_ID,
   AUD_LEAD_STATUS,
   AUDIT_SEQ_NO,
   COMPANY_ID,
   AUDIT_TYPE_ID,
   VESSEL_IMO_NO,
   AUDIT_SUB_TYPE_ID,
   CERTIFICATE_NO,
   AUDIT_REPORT_NO,
   AUDIT_DATE,
   COMPANY_IMO_NO,
   COMPANY_DOC,
   AUDIT_STATUS_ID,
   CERTIFICATE_ISSUE_ID,
   CERT_EXPIRY_DATE,
   CERT_ISSUED_DATE,
   ALLOW_NEXT,
   LOCK_STATUS,
   REVIEW_STATUS,
   CREDIT_DATE,
   IS_AUDIT_LOCKED_BY_MANAGER,
   PUBLISH_STATUS,
   SCOPE,
   OFFICIAL_NO,
   LETTER_NO,
   ADDITIONAL_SURVEY
)
AS
   (SELECT AAD.USER_ID,
           AAD.AUD_LEAD_STATUS,
           AD.AUDIT_SEQ_NO,
           AD.COMPANY_ID,
           AD.AUDIT_TYPE_ID,
           AD.VESSEL_IMO_NO,
           AD.AUDIT_SUB_TYPE_ID,
           AD.CERTIFICATE_NO,
           AD.AUDIT_REPORT_NO,
           AD.AUDIT_DATE,
           AD.COMPANY_IMO_NO,
           AD.COMPANY_DOC,
           AD.AUDIT_STATUS_ID,
           AD.CERTIFICATE_ISSUE_ID,
           AD.CERT_EXPIRY_DATE,
           AD.CERT_ISSUED_DATE,
           AD.ALLOW_NEXT,
           AD.LOCK_STATUS,
           AD.REVIEW_STATUS,
           AD.CREDIT_DATE,
           NVL (
              (SELECT UR.ROLE_ID
                 FROM MA_USER_ROLES UR
                WHERE     AD.AUDIT_SEQ_NO = AAD.AUDIT_SEQ_NO
                      AND UR.USER_ID = AD.LOCK_HOLDER
                      AND AD.COMPANY_ID = UR.COMPANY_ID),
              0)
              IS_AUDIT_LOCKED_BY_MANAGER,
           NVL (
              (SELECT CD.PUBLISH_STATUS
                 FROM CERTIFICATE_DETAIL CD
                WHERE     AD.AUDIT_SEQ_NO = CD.AUDIT_SEQ_NO
                      AND AD.COMPANY_ID = CD.COMPANY_ID
                      AND CD.SEQ_NO = 1
                      AND ROWNUM = 1),
              0)
              PUBLISH_STATUS,
           AD.SCOPE,
           (SELECT MV.OFFICIAL_NO
              FROM MA_VESSEL MV
             WHERE MV.VESSEL_IMO_NO = AD.VESSEL_IMO_NO
                   AND MV.COMPANY_ID = AD.COMPANY_ID)
              OFFICIAL_NO,
           AD.LETTER_NO,
           AD.ADDITIONAL_SURVEY
      FROM AUDIT_DETAILS AD, AUDIT_AUDITOR_DETAILS AAD
     WHERE AAD.AUDIT_SEQ_NO = AD.AUDIT_SEQ_NO);


GRANT INSERT, SELECT, UPDATE ON AUDIT_STAG_TEST.AUDIT_DETAILS_VIEW TO AUDIT_PROD_LOG;
